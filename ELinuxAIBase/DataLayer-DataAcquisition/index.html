<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-ELinuxAIBase/DataLayer-DataAcquisition" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">9.数据层-数据采集 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://eai.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://eai.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://eai.100ask.net/ELinuxAIBase/DataLayer-DataAcquisition"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="9.数据层-数据采集 | 东山Π"><meta data-rh="true" name="description" content="1.1 视频数据采集-V4L2"><meta data-rh="true" property="og:description" content="1.1 视频数据采集-V4L2"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://eai.100ask.net/ELinuxAIBase/DataLayer-DataAcquisition"><link data-rh="true" rel="alternate" href="https://eai.100ask.net/ELinuxAIBase/DataLayer-DataAcquisition" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://eai.100ask.net/en/ELinuxAIBase/DataLayer-DataAcquisition" hreflang="en"><link data-rh="true" rel="alternate" href="https://eai.100ask.net/ELinuxAIBase/DataLayer-DataAcquisition" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e3ab61ce.css">
<script src="/assets/js/runtime~main.8555e319.js" defer="defer"></script>
<script src="/assets/js/main.62526710.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">eLinux AI开发</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ELinuxAIBase/BoardIntroduction-1">嵌入式AI基础</a><a class="navbar__item navbar__link" href="/CanaanK230/Userdoc">嘉楠K230开发</a><a class="navbar__item navbar__link" href="/CanaanK510/YOLOV5-ObjectDetectionAlgorithm">嘉楠K510开发</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/ELinuxAIBase/DataLayer-DataAcquisition" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/ELinuxAIBase/DataLayer-DataAcquisition" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/eLinuxAI-TrainingDocs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/BoardIntroduction-1">1. 嵌入式AI学习路线</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/BoardIntroduction">2. 资料下载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/ArtificialIntelligenceAndMachineLearning">3. 人工智能与机器学习</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/DeepLearningAndNeuralNetworks">4.深度学习及神经网络</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/BasicOperatorsAndConvolutionalNeuralNetworks">5.基础算子及卷积神经网络</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/IntroductionToDeepLearningFrameworkPytorch">6.深度学习框架Pytorch入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/ModelAndDeployment">7.模型及部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/EdgeDeployment">8.边缘部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/ELinuxAIBase/DataLayer-DataAcquisition">9.数据层-数据采集</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/ModelLayerAndComputingPowerLayer">10.模型层和算力层</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ELinuxAIBase/FunctionModule">11.功能模块</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">9.数据层-数据采集</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>9.数据层-数据采集</h1>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-视频数据采集-v4l2">1.1 视频数据采集-V4L2<a href="#11-视频数据采集-v4l2" class="hash-link" aria-label="1.1 视频数据采集-V4L2的直接链接" title="1.1 视频数据采集-V4L2的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="111-数据采集流程">1.1.1 数据采集流程<a href="#111-数据采集流程" class="hash-link" aria-label="1.1.1 数据采集流程的直接链接" title="1.1.1 数据采集流程的直接链接">​</a></h4>
<p>可以参考这些文件：</p>
<ul>
<li>mjpg-streamer\mjpg-streamer-experimental\plugins\input_control\input_uvc.c</li>
<li>video2lcd\video\v4l2.c</li>
</ul>
<p>Video for Linux two(Video4Linux2)简称V4L2，是V4L的改进版。V4L2支持三种方式来采集图像：内存映射方式(mmap)、直接读取方式(read)和用户指针。内存映射的方式采集速度较快，一般用于连续视频数据的采集，实际工作中的应用概率更高；直接读取的方式相对速度慢一些，所以常用于静态图片数据的采集；用户指针使用较少，如有兴趣可自行研究。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="112-buffer的管理">1.1.2 buffer的管理<a href="#112-buffer的管理" class="hash-link" aria-label="1.1.2 buffer的管理的直接链接" title="1.1.2 buffer的管理的直接链接">​</a></h4>
<p>使用摄像头时，核心是&quot;获得数据&quot;。所以先讲如何获取数据，即如何得到buffer。</p>
<p>摄像头  采集数据时，是一帧又一帧地连续采集。所以需要申请若干个buffer，驱动程序把数据放入buffer，APP从buffer得到数据。这些buffer可以使用链表来管理。</p>
<p>驱动程序周而复始地做如下事情：</p>
<ul>
<li>从硬件采集到数据</li>
<li>把&quot;空闲链表&quot;取出buffer，把数据存入buffer</li>
<li>把含有数据的buffer放入&quot;完成链表&quot;</li>
</ul>
<p>APP也会周而复始地做如下事情：</p>
<ul>
<li>监测&quot;完成链表&quot;，等待它含有buffer</li>
<li>从&quot;完成链表&quot;中取出buffer</li>
<li>处理数据</li>
<li>把buffer放入&quot;空闲链表&quot;</li>
</ul>
<p>链表操作示意图如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/05_buffers-1700192997818-3.png" alt="image-20230617171816630" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="112-完整的使用流程">1.1.2 完整的使用流程<a href="#112-完整的使用流程" class="hash-link" aria-label="1.1.2 完整的使用流程的直接链接" title="1.1.2 完整的使用流程的直接链接">​</a></h4>
<p>参考mjpg-streamer和video2lcd，总结了摄像头的使用流程，如下：</p>
<ul>
<li>open：打开设备节点/dev/videoX</li>
<li>ioctl VIDIOC_QUERYCAP：Query Capbility，查询能力，比如<!-- -->
<ul>
<li>确认它是否是&quot;捕获设备&quot;，因为有些节点是输出设备</li>
<li>确认它是否支持mmap操作，还是仅支持read/write操作</li>
</ul>
</li>
<li>ioctl VIDIOC_ENUM_FMT：枚举它支持的格式</li>
<li>ioctl VIDIOC_S_FMT：在上面枚举出来的格式里，选择一个来设置格式</li>
<li>ioctl VIDIOC_REQBUFS：申请buffer，APP可以申请很多个buffer，但是驱动程序不一定能申请到</li>
<li>ioctl VIDIOC_QUERYBUF和mmap：查询buffer信息、映射<!-- -->
<ul>
<li>如果申请到了N个buffer，这个ioctl就应该执行N次</li>
<li>执行mmap后，APP就可以直接读写这些buffer</li>
</ul>
</li>
<li>ioctl VIDIOC_QBUF：把buffer放入&quot;空闲链表&quot;<!-- -->
<ul>
<li>如果申请到了N个buffer，这个ioctl就应该执行N次</li>
</ul>
</li>
<li>ioctl VIDIOC_STREAMON：启动摄像头</li>
<li>这里是一个循环：使用poll/select监测buffer，然后从&quot;完成链表&quot;中取出buffer，处理后再放入&quot;空闲链表&quot;<!-- -->
<ul>
<li>poll/select</li>
<li>ioctl VIDIOC_DQBUF：从&quot;完成链表&quot;中取出buffer</li>
<li>处理：前面使用mmap映射了每个buffer的地址，处理时就可以直接使用地址来访问buffer</li>
<li>ioclt VIDIOC_QBUF：把buffer放入&quot;空闲链表&quot;</li>
</ul>
</li>
<li>ioctl VIDIOC_STREAMOFF：停止摄像头</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-控制流程">1.2 控制流程<a href="#12-控制流程" class="hash-link" aria-label="1.2 控制流程的直接链接" title="1.2 控制流程的直接链接">​</a></h3>
<p>使用摄像头时，我们可以调整很多参数，比如：</p>
<ul>
<li>
<p>对于视频流本身：</p>
<ul>
<li>设置格式：比如V4L2_PIX_FMT_YUYV、V4L2_PIX_FMT_MJPEG、V4L2_PIX_FMT_RGB565</li>
<li>设置分辨率：1024*768等</li>
</ul>
</li>
<li>
<p>对于控制部分：</p>
<ul>
<li>调节亮度</li>
<li>调节对比度</li>
<li>调节色度</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="121-app接口">1.2.1 APP接口<a href="#121-app接口" class="hash-link" aria-label="1.2.1 APP接口的直接链接" title="1.2.1 APP接口的直接链接">​</a></h4>
<p>就APP而言，对于这些参数有3套接口：查询或枚举(Query/Enum)、获得(Get)、设置(Set)。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1211-数据格式">1.2.1.1 数据格式<a href="#1211-数据格式" class="hash-link" aria-label="1.2.1.1 数据格式的直接链接" title="1.2.1.1 数据格式的直接链接">​</a></h5>
<p>以设置数据格式为例，可以先枚举：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1211-数据格式-1">1.2.1.1 数据格式<a href="#1211-数据格式-1" class="hash-link" aria-label="1.2.1.1 数据格式的直接链接" title="1.2.1.1 数据格式的直接链接">​</a></h5>
<p>以设置数据格式为例，可以先枚举：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_fmtdesc</span><span class="token plain"> fmtdesc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 比如从0开始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指定type为&quot;捕获&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_ENUM_FMT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fmtdesc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *	F O R M A T   E N U M E R A T I O N</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_fmtdesc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		    index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* Format number      */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		    type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_buf_type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32               flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u8		    description</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* Description string */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		    pixelformat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/* Format fourcc      */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		    reserved</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>还可以获得当前的格式：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_format</span><span class="token plain"> currentFormat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">currentFormat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_format</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currentFormat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_G_FMT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">currentFormat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_format</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32	 type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_pix_format</span><span class="token plain">		pix</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_VIDEO_CAPTURE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_pix_format_mplane</span><span class="token plain">	pix_mp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_window</span><span class="token plain">		win</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_VIDEO_OVERLAY */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_vbi_format</span><span class="token plain">		vbi</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_VBI_CAPTURE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_sliced_vbi_format</span><span class="token plain">	sliced</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_SLICED_VBI_CAPTURE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_sdr_format</span><span class="token plain">		sdr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* V4L2_BUF_TYPE_SDR_CAPTURE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		__u8	raw_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">/* user-defined */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *	V I D E O   I M A G E   F O R M A T</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_pix_format</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">v4l2_format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32         		width</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			height</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			pixelformat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			field</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_field */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32            	bytesperline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* for padding, zero if unused */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32          		sizeimage</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			colorspace</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_colorspace */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			priv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* private data, depends on pixelformat */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* format flags (V4L2_PIX_FMT_FLAG_*) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			ycbcr_enc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_ycbcr_encoding */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			quantization</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_quantization */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32			xfer_func</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_xfer_func */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>也可以设置当前的格式：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_format</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_format</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">768</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pixelformat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_PIX_FMT_MJPEG</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">field </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_FIELD_ANY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_S_FMT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1212-选择输入源">1.2.1.2 选择输入源<a href="#1212-选择输入源" class="hash-link" aria-label="1.2.1.2 选择输入源的直接链接" title="1.2.1.2 选择输入源的直接链接">​</a></h5>
<p>可以获得当期输入源、设置当前输入源：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">VIDIOC_G_INPUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 读到的value从0开始, 0表示第1个input源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 0表示第1个input源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">VIDIOC_S_INPUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1213-其他参数">1.2.1.3 其他参数<a href="#1213-其他参数" class="hash-link" aria-label="1.2.1.3 其他参数的直接链接" title="1.2.1.3 其他参数的直接链接">​</a></h5>
<p>如果每一参数都提供一系列的ioctl cmd，那使用起来很不方便。</p>
<p>对于这些参数，APP使用对应ID来选中它，然后使用VIDIOC_QUERYCTRL、VIDIOC_G_CTRL、VIDIOC_S_CTRL来操作它。</p>
<p>不同参数的ID值不同。</p>
<p>以亮度Brightness为例，有如下调用方法:</p>
<ul>
<li>查询：</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_queryctrl</span><span class="token plain">   qctrl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">qctrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qctrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qctrl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_CID_BRIGHTNESS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// V4L2_CID_BASE+0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_QUERYCTRL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">qctrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*  Used in the VIDIOC_QUERYCTRL ioctl for querying controls */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_queryctrl</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		     id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		     type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* enum v4l2_ctrl_type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u8		     name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Whatever */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     minimum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Note signedness */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     maximum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     default_value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32                flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		     reserved</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>获得当前值</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_control</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_CID_BRIGHTNESS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// V4L2_CID_BASE+0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_G_CTRL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *	C O N T R O L S</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_control</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		     id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>设置</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_control</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_CID_BRIGHTNESS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// V4L2_CID_BASE+0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">99</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_S_CTRL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="122-理解接口">1.2.2 理解接口<a href="#122-理解接口" class="hash-link" aria-label="1.2.2 理解接口的直接链接" title="1.2.2 理解接口的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1221-概念">1.2.2.1 概念<a href="#1221-概念" class="hash-link" aria-label="1.2.2.1 概念的直接链接" title="1.2.2.1 概念的直接链接">​</a></h5>
<p>以USB摄像头为例，它的内部结构如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/07_uvc_topology.png" alt="image-20230725082453370" class="img_ev3q"></p>
<p>一个USB摄像头必定有一个VideoControl接口，用于控制。有0个或多个VideoStreaming接口，用于传输视频。</p>
<p>在VideoControl内部，有多个Unit或Terminal，上一个Unit或Terminal的数据，流向下一个Unit或Terminal，多个Unit或Terminal组成一个完整的UVC功能设备。</p>
<ul>
<li>
<p>只有一个输出引脚
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/11_unit_example.png" alt="image-20230725083717206" class="img_ev3q"></p>
</li>
<li>
<p>可以Fan-out，不能Fan-in
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/12_fanout_fanin.png" alt="image-20230725084117149" class="img_ev3q"></p>
</li>
<li>
<p>Terminal：位于边界，用于联通外界。有：IT(Input Terminal)、OT(Output Terminal)、CT(Camera Terminal)。模型如下，有一个输出引脚：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/08_itot.png" alt="image-20230725082942680" class="img_ev3q"></p>
</li>
<li>
<p>Unit：位于VideoControl内部，用来进行各种控制</p>
<ul>
<li>SU：Selector Unit(选择单元)，从多路输入中选择一路，比如设备支持多种输入源，可以通过SU进行选择切换。模型如下
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/09_su.png" alt="image-20230725083123895" class="img_ev3q"></li>
<li>PU：Porocessing Unit(处理单元)，用于调整亮度、对比度、色度等，有如下控制功能：<!-- -->
<ul>
<li>User Controls<!-- -->
<ul>
<li>Brightness 背光</li>
<li>Hue 色度</li>
<li>Saturation 饱和度</li>
<li>Sharpness 锐度</li>
<li>Gamma 伽马</li>
<li>Digital Multiplier (Zoom) 数字放大</li>
</ul>
</li>
<li>Auto Controls<!-- -->
<ul>
<li>White Balance Temperature 白平衡色温</li>
<li>White Balance Component 白平衡组件</li>
<li>Backlight Compensation 背光补偿</li>
<li>Contrast 对比度</li>
</ul>
</li>
<li>Other<!-- -->
<ul>
<li>Gain 增益</li>
<li>Power Line Frequency 电源线频率</li>
<li>Analog Video Standard 模拟视频标准</li>
<li>Analog Video Lock Status 模拟视频锁状态</li>
</ul>
</li>
<li>模型如下
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/10_pu.png" alt="image-20230725083301071" class="img_ev3q"></li>
</ul>
</li>
<li>EU：Encoding Unit(编码单元)，对采集所得的数据进行个性化处理的功能。编码单元控制编码器的属性，该编码器对通过它流式传输的视频进行编码。它具有如下功能：
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/13_eu_functions.png" alt="image-20230725084636672" class="img_ev3q"></li>
<li>模型如下
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/14_eu.png" alt="image-20230725084743426" class="img_ev3q"></li>
</ul>
</li>
<li>
<p>XU：Extension Unit(扩展单元)，厂家可以在XU上提供自定义的操作，模型如下：
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/15_xu.png" alt="image-20230725084952604" class="img_ev3q"></p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1222-操作方法">1.2.2.2 操作方法<a href="#1222-操作方法" class="hash-link" aria-label="1.2.2.2 操作方法的直接链接" title="1.2.2.2 操作方法的直接链接">​</a></h5>
<p>我们使用ioctl操作设备节点&quot;/dev/video0&quot;时，不同的ioctl操作的可能是VideoControl接口，或者VideoStreaming接口。</p>
<p>跟视频流相关的操作，比如：VIDIOC_ENUM_FMT、VIDIOC_G_FMT、VIDIOC_S_FMT、VIDIOC_STREAMON、VIDIOC_STREAMOFF，是操作VideoStreaming接口。</p>
<p>其他ioctl，大多都是操作VideoControl接口。</p>
<p>从底层驱动和硬件角度看，要操作VideoControl接口，需要指明：</p>
<ul>
<li>entity：你要操作哪个Terminal或Unit，比如PU</li>
<li>Control Selector：你要操作entity里面的哪个控制项？比如亮度PU_BRIGHTNESS_CONTROL</li>
<li>控制项里哪些位：比如CT(Camera Terminal)里的CT_PANTILT_RELATIVE_CONTROL控制项对应32位的数据，其中前16位对应PAN控制(左右转动)，后16位对应TILE控制(上下转动)</li>
</ul>
<p>但是APP不关注这些细节，使用一个ID来指定entity、Control Selector、哪些位：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *	C O N T R O L S</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_control</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__u32		     id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	__s32		     value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>驱动程序里，会解析APP传入的ID，找到entity、Control Selector、那些位。</p>
<p>但是有了上述知识后，我们才能看懂mjpg-streamer的如下代码：</p>
<ul>
<li>
<p>XU：使用比较老的UVC驱动时，需要APP传入厂家的XU信息；新驱动里可以解析出XU信息，无需APP传入
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/16_logitech_xu.png" alt="image-20230725091551391" class="img_ev3q"></p>
</li>
<li>
<p>mapping：无论新老UVC驱动，都需要提供更细化的mapping信息</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/17_logitech_mapping.png" alt="image-20230725092210341" class="img_ev3q"></p>
</li>
<li>
<p>代码</p>
</li>
<li>
<p>如下
<img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/18_add_control_mapping.png" alt="image-20230725092349892" class="img_ev3q"></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-编写app">1.3 编写APP<a href="#13-编写app" class="hash-link" aria-label="1.3 编写APP的直接链接" title="1.3 编写APP的直接链接">​</a></h3>
<p>参考：mjpg-streamer，<a href="https://github.com/jacksonliam/mjpg-streamer" target="_blank" rel="noopener noreferrer">https://github.com/jacksonliam/mjpg-streamer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="131-列出帧细节">1.3.1 列出帧细节<a href="#131-列出帧细节" class="hash-link" aria-label="1.3.1 列出帧细节的直接链接" title="1.3.1 列出帧细节的直接链接">​</a></h4>
<p>调用ioctl VIDIOC_ENUM_FMT可以枚举摄像头支持的格式，但是无法获得更多细节（比如支持哪些分辨率），</p>
<p>调用ioctl VIDIOC_G_FMT可以获得&quot;当前的格式&quot;，包括分辨率等细节，但是无法获得其他格式的细节。</p>
<p>需要结合VIDIOC_ENUM_FMT、VIDIOC_ENUM_FRAMESIZES这2个ioctl来获得这些细节：</p>
<ul>
<li>VIDIOC_ENUM_FMT：枚举格式</li>
<li>VIDIOC_ENUM_FRAMESIZES：枚举指定格式的帧大小(即分辨率)</li>
</ul>
<p>示例代码如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/types.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/stat.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;fcntl.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/ioctl.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/types.h&gt;</span><span class="token macro property" style="color:#36acaa">          </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* for videodev2.h */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/videodev2.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* ./video_test &lt;/dev/video0&gt; */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_fmtdesc</span><span class="token plain"> fmtdesc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_frmsizeenum</span><span class="token plain"> fsenum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fmt_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> frame_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Usage: %s &lt;/dev/videoX&gt;, print format detail for video device\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* open */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDWR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;can not open %s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 枚举格式 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 比如从0开始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指定type为&quot;捕获&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_ENUM_FMT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fmtdesc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        frame_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* 枚举这种格式所支持的帧大小 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fsenum</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_frmsizeenum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fsenum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pixel_format </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pixelformat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fsenum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VIDIOC_ENUM_FRAMESIZES</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fsenum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;format %s,%d, framesize %d: %d x %d\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">description</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmtdesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pixelformat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> frame_index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fsenum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">discrete</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fsenum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">discrete</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frame_index</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt_index</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="132-获取数据">1.3.2 获取数据<a href="#132-获取数据" class="hash-link" aria-label="1.3.2 获取数据的直接链接" title="1.3.2 获取数据的直接链接">​</a></h4>
<p>根据《1.2 完整的使用流程》来编写程序，步骤如下：</p>
<ul>
<li>打开设备</li>
<li>ioctl VIDIOC_QUERYCAP：Query Capbility，查询能力</li>
<li>枚举格式、设置格式</li>
<li>ioctl VIDIOC_REQBUFS：申请buffer</li>
<li>ioctl VIDIOC_QUERYBUF和mmap：查询buffer信息、映射</li>
<li>ioctl VIDIOC_QBUF：把buffer放入&quot;空闲链表&quot;</li>
<li>ioctl VIDIOC_STREAMON：启动摄像头</li>
<li>这里是一个循环：使用poll/select监测buffer，然后从&quot;完成链表&quot;中取出buffer，处理后再放入&quot;空闲链表&quot;<!-- -->
<ul>
<li>poll/select</li>
<li>ioctl VIDIOC_DQBUF：从&quot;完成链表&quot;中取出buffer</li>
<li>处理：前面使用mmap映射了每个buffer的地址，把这个buffer的数据存为文件</li>
<li>ioclt VIDIOC_QBUF：把buffer放入&quot;空闲链表&quot;</li>
</ul>
</li>
<li>ioctl VIDIOC_STREAMOFF：停止摄像头</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/19_get_data.png" alt="image-20230726162003001" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="133-控制亮度">1.3.3 控制亮度<a href="#133-控制亮度" class="hash-link" aria-label="1.3.3 控制亮度的直接链接" title="1.3.3 控制亮度的直接链接">​</a></h4>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/20_brightness.png" alt="image-20230726170548040" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-数据层-数据预处理">2. 数据层-数据预处理<a href="#2-数据层-数据预处理" class="hash-link" aria-label="2. 数据层-数据预处理的直接链接" title="2. 数据层-数据预处理的直接链接">​</a></h2>
<p>​	我们从摄像头采集到图像数据后，需要对图像进行格式的转换或图像的缩放等就需要操作图像，在图像处理领域，OpenCV库提供了很多常用的图像预处理方法，用于准备图像数据以用于计算机视觉和深度学习任务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-opencv计算机视觉库">1.1 OpenCV计算机视觉库<a href="#11-opencv计算机视觉库" class="hash-link" aria-label="1.1 OpenCV计算机视觉库的直接链接" title="1.1 OpenCV计算机视觉库的直接链接">​</a></h3>
<p>​	OpenCV(开源计算机视觉库)是一个基于Apache2.0许可（开源）的计算机视觉和机器学习软件库。OpenCV旨在为计算机视觉应用提供一个公共基础设施，并加速机器感知在商业产品中的应用。</p>
<p>​	OpenCV库拥有超过2500种优化算法，包括一套全面的经典和最先进的计算机视觉和机器学习算法。这些算法可用于检测和识别人脸、识别物体、对视频中的人类动作进行分类、跟踪相机运动、跟踪运动物体、提取物体的3D模型、从立体相机产生3D点云、将图像拼接在一起以产生整个场景的高分辨率图像、从图像数据库中找到相似的图像、从使用闪光灯拍摄的图像中去除红眼、跟随眼球运动、识别风景并建立标记以用增强现实覆盖等。</p>
<p>​	它轻量级而且高效——由一系列 C 函数和少量 <a href="https://baike.baidu.com/item/C%2B%2B/99272?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">C++</a> 类构成，同时提供了Python、<a href="https://baike.baidu.com/item/Ruby/11419?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">Ruby</a>、<a href="https://baike.baidu.com/item/MATLAB/263035?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">MATLAB</a>等语言的接口，实现了<a href="https://baike.baidu.com/item/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/294902?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">图像处理</a>和计算机视觉方面的很多通用算法。它拥有C++、Python、Java和MATLAB接口，支持Windows、Linux、<a href="https://opencv.org/opencv//android/" target="_blank" rel="noopener noreferrer">安卓</a>和Mac OS。OpenCV主要倾向于实时视觉应用，并在可用时利用MMX和SSE指令。功能齐全的<a href="https://opencv.org/opencv//cuda/" target="_blank" rel="noopener noreferrer">CUDA</a>和<a href="https://opencv.org/opencv//opencl/" target="_blank" rel="noopener noreferrer">OpenCL</a>现在正在积极开发接口。有500多种算法和大约10倍多的函数组成或支持这些算法。OpenCV是用C++原生编写的，它有一个模板化的接口，可以与STL容器无缝协作。</p>
<p>​	OpenCV官方网站：<a href="https://opencv.org/" target="_blank" rel="noopener noreferrer">https://opencv.org/</a></p>
<p>​	OpenCV开源代码仓库：<a href="https://github.com/opencv/opencv" target="_blank" rel="noopener noreferrer">https://github.com/opencv/opencv</a></p>
<p>​	OpenCV官方文档站点：<a href="https://docs.opencv.org/" target="_blank" rel="noopener noreferrer">https://docs.opencv.org/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-opencv入门">1.2 OpenCV入门<a href="#12-opencv入门" class="hash-link" aria-label="1.2 OpenCV入门的直接链接" title="1.2 OpenCV入门的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="121-opencv开发环境搭建">1.2.1 OpenCV开发环境搭建<a href="#121-opencv开发环境搭建" class="hash-link" aria-label="1.2.1 OpenCV开发环境搭建的直接链接" title="1.2.1 OpenCV开发环境搭建的直接链接">​</a></h4>
<p>​	在开始学习OpenCV时都会遇到一个问题，那就是如何搭建OpenCV的C++和Python开发环境，那么我们就给大家准备好了一个Ubuntu虚拟机，可以统一大家的环境，让大家学习可以快速把环境搭建起来。如果您想直接查看OpenCV官方文档安装可访问：<a href="https://opencv.org/get-started/" target="_blank" rel="noopener noreferrer">https://opencv.org/get-started/</a></p>
<p>​	下面我们展示如何在虚拟机中安装OpenCV的C++版本，打开终端命令行，输入</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install libopencv-dev -y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>等待安装完成即可。</p>
<p>​	如果你是使用我们准备在资料光盘<code>2_DongshanPI-Vision_配套工具/【VMware】Ubuntu-20.04虚拟机系统镜像-AI应用开发</code>中的虚拟机镜像已经默认安装好了python版的OpenCV，可直接使用。如果您使用自己的虚拟机可输入</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip3 install opencv-python</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>注意：执行后会使用pip安装opencv，需要您提前安装好pip!</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="122-第一个opencv开发程序">1.2.2 第一个OpenCV开发程序<a href="#122-第一个opencv开发程序" class="hash-link" aria-label="1.2.2 第一个OpenCV开发程序的直接链接" title="1.2.2 第一个OpenCV开发程序的直接链接">​</a></h4>
<p>​	本章节在Linux中使用一个简单的OpenCV演示程序，通过读取图像数据的过程来讲解OpenCV中常见用的几个函数。</p>
<p><strong>python 版本：</strong></p>
<p>新建python程序文件hello-opencv.py，程序文件内容为：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#导入opencv模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cv2 </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> cv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#读取当前目录图像，支持 bmp、jpg、png、tiff 等常用格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test.jpg&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#创建一个hello-opencv窗口用于显示图像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">namedWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello-opencv&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在hello-opencv窗口中展示输入图像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imshow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello-opencv&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#将RGB彩色图像转化为灰度图</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img_gray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cvtColor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">COLOR_RGB2GRAY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#创建一个Img_gray窗口用于显示图像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">namedWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Img_gray&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在Img_gray窗口中展示输入图像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imshow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Img_gray&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">img_gray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#将灰度图像在当前目录下保存为jpg文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test_gray.jpg&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">img_gray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#创建的窗口持续显示，直至按下键盘中任意键</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waitKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#释放窗口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destroyAllWindows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>C++版本：</strong></p>
<p>新建c++程序文件hello-opencv.cpp，程序文件内容为：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include&lt;opencv2/opencv.hpp&gt; //包含opencv库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::string image_path = &quot;/home/ubuntu/work/hello-opencv-c++/test.jpg&quot;; //获得图片路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //读取当前目录图像，支持 bmp、jpg、png、tiff 等常用格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat img = cv::imread(image_path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建一个hello-opencv窗口用于显示图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::namedWindow(&quot;hello-opencv&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在hello-opencv窗口中展示输入图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::imshow(&quot;hello-opencv&quot;, img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建Mat对象，用于存储灰度图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat img_gray;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //将RGB彩色图像转化为灰度图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::cvtColor(img,img_gray,cv::COLOR_RGB2GRAY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建一个Img_gray窗口用于显示图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::namedWindow(&quot;Img_gray&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在Img_gray窗口中展示输入图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::imshow(&quot;Img_gray&quot;,img_gray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //将灰度图像在当前目录下保存为jpg文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::imwrite(&quot;test_gray.jpg&quot;,img_gray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建的窗口持续显示，直至按下键盘中任意键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::waitKey(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //释放窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::destroyAllWindows();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编写完成程序后，我们需要将将测试图像<code>test.jpg</code>放在对应文件夹中，那么下面我们来看一下两个程序分别如何运行。</p>
<p><strong>python程序编译运行：</strong></p>
<p>打开终端界面，输入</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python hello</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">opencv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>C++程序编译运行：</strong></p>
<p>新建一个CMakeLists.txt文件，填入以下内容</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake_minimum_required(VERSION 2.8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project( hello-opencv )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">find_package( OpenCV REQUIRED )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories( ${OpenCV_INCLUDE_DIRS} )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_executable( hello-opencv hello-opencv.cpp )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries( hello-opencv ${OpenCV_LIBS} )</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>打开终端界面，新建一个build目录，存放编译后的缓存和可执行程序：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>新建完成后，进入build目录后，使用cmake生成编译规则</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd build/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmake..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>生成完成编译规则即可开始编译程序</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译完成后可以看到build目录下会生成<code>hello-opencv</code>可执行文件，如下所示，执行可执行文件。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./hello-opencv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码运行完成后会弹出两个窗口显示图像。分别是输入图像的hello-opencv窗口和图像经过灰度化处理的Img_gray窗口，如下所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231212105301905.png" alt="image-20231212105301905" class="img_ev3q"></p>
<p>如果您想结束两个窗口，可以按下任意键结束这两个窗口。我们可以看到程序运行完成之后，可以在当前目录下看到灰度图像文件<code>test_gray.jpg</code>。如下所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231212112828696.png" alt="image-20231212112828696" class="img_ev3q"></p>
<p>​	下面我们简单介绍每个函数的作用：</p>
<ul>
<li>imread：从图像文件中读取图像数据并返回图像数据，返回的图像数据存储为Mat对象。输入参数为：图像文件路径</li>
<li>namedWindow：创建一个窗口，传入窗口的名称。输入参数为：窗口名称</li>
<li>imshow:可以在窗口中显示图像，该窗口和图像原始的大小自适应。输入参数为：窗口名称、输入图像</li>
<li>cvtColor：将输入图像从一个色彩空间转化为另一个色彩空间。输入参数为：输入图像、转化格式</li>
<li>imwrite：保存图像并写入指定的文件中，输入参数为：文件路径、输入图像</li>
<li>waitKey：用于等待用户按键输入的一个函数，给定的时间内等待用户按键触发，如果用户没有按下键，就继续等待。设置waitKey(0)，则表示程序会无限制的等待用户的按键时间。</li>
<li>destroyAllWindows：该函数用于删除窗口的，（）里不指定任何参数，则删除所有窗口，删除特定的窗口，往（）输入特定的窗口值。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="123-读取摄像头并保存图像">1.2.3 读取摄像头并保存图像<a href="#123-读取摄像头并保存图像" class="hash-link" aria-label="1.2.3 读取摄像头并保存图像的直接链接" title="1.2.3 读取摄像头并保存图像的直接链接">​</a></h4>
<p>OpenCV提供了操作视频的接口类VideoCapture,VideoCapture类可以从文件或者摄像设备中读取视频。VideoCapture提供了常用的三种构造函数：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VideoCapture::VideoCapture()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VideoCapture::VideoCapture(int device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VideoCapture::VideoCapture(const string&amp; filename);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：</p>
<ul>
<li>
<p>第一个是默认无参构造函数</p>
</li>
<li>
<p>第二个中参数device指定要打开的摄像头设备</p>
</li>
<li>
<p>第三个构造函数中filename 是指要打开的视频文件路径以及名称；</p>
</li>
</ul>
<p>VideoCapture类还提供了read方法并且使用了重载运算符&gt;&gt; 获取视频的每一帧。</p>
<p>​	本章节介绍在虚拟机Ubuntu端的Linux系统中，使用OpenCV访问USB摄像头获取图像数据，并实时显示摄像头数据，按下<code>t</code>拍照。</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/opencv.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace cv;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace std;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//读取视频或摄像头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	VideoCapture capture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //capture.open(&quot;/dev/video0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.open(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!capture.isOpened())//判断摄像头是否可以正常打开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;open video0 success!!&quot;&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int cap_width = capture.get(CAP_PROP_FRAME_WIDTH);//获取摄像头参数-宽度 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int cap_height = capture.get(CAP_PROP_FRAME_HEIGHT);//获得摄像头参数-高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;capture width:&quot;&lt;&lt;cap_width&lt;&lt;&quot;capture height:&quot;&lt;&lt;cap_height&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FRAME_WIDTH, cap_width); //设置摄像头获得图像的宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FRAME_HEIGHT, cap_height); //设置摄像头获得图像的高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FOURCC, VideoWriter::fourcc(&#x27;M&#x27;, &#x27;J&#x27;, &#x27;P&#x27;, &#x27;G&#x27;));//视频的编码格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namedWindow(&quot;capture&quot;); //创建capture窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string Path = &quot;./take_pictures&quot;; //设置照片保存路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string Imgname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	while (true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Mat frame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		int ret = capture.read(frame);//读取摄像头资源存入frame对象中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (&#x27;t&#x27; == waitKey(20)) //如果按下`t`键，就进入拍照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Imgname = Path + to_string(i)+&quot;.jpg&quot;; //图像路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            imwrite(Imgname, frame);//将frame图像存在Imgname图像路径中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cout &lt;&lt; Imgname &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		imshow(&quot;capture&quot;, frame);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.release();//释放摄像头资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::destroyAllWindows();//释放窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行程序后，会弹出capture窗口，该窗口就会实时预  览USB摄像头数据</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231218193633189.png" alt="image=" class="img_ev3q"></p>
<p>按下<code>t</code>即可对图像进行拍照，拍照后的图像文件会保存在当前路径。</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231218194200942.png" alt="image-20231218194200942" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="124-mat数据结构">1.2.4 Mat数据结构<a href="#124-mat数据结构" class="hash-link" aria-label="1.2.4 Mat数据结构的直接链接" title="1.2.4 Mat数据结构的直接链接">​</a></h4>
<p>​	本章节重点介绍Mat数据结构，我们上一小节已经通过imread读取了一张图像，并存储在Mat数据类型中。OpenCV对于Mat数据类型介绍：<a href="https://docs.opencv.org/4.8.0/de/d7a/tutorial_table_of_content_core.html" target="_blank" rel="noopener noreferrer">Mat - 基本图像容器</a>。</p>
<p>​	我们先来从官方文档中来看，Mat对象的用途：</p>
<ul>
<li>图像容器类（可以存储图像）</li>
<li>通用的矩阵类（可以创建和操作多维矩阵）</li>
</ul>
<p>那么为什么又可以存储图像又可以存储矩阵呢？我们从官方文档来看。我们通过电子设备从现实世界获得的数字图像，那么我们通过设备记录下来的就是每个点的数值构成的图像。如下所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/MatBasicImageForComputer-1702374941737-5.jpg" alt="image=" class="img_ev3q"></p>
<p>也就说相机记录的数据集是像上图所示的数据，也就是像矩阵一样的数据，记录每个像素点中的数据，而Mat保存的图像数据就是保存图像中各个通道的像素值，即Mat将图像数据按行按列的顺序进行存放数据矩阵。如下图所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231212180206015.png" alt="image=" class="img_ev3q"></p>
<p>​	Mat数据类型的结构分为两部分：信息头和指向像素数据的矩阵指针。</p>
<p>信息头包括数字图像的矩阵尺寸（row、cols）、存储方法、存储地址。</p>
<p>指向存储所有像素值的矩阵的指针。</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231213142235194.png" alt="image=" class="img_ev3q"></p>
<p>我们就可以发现，如果我们去改变图像中的像素值时，通常改变的数据量是很大的，我们需要对图像像素数据的矩阵中的每一个值进行修改。因此，如果我们需要在程序中传递图像并拷贝时会产生很大的内存开销，因为我们知道我们在进行图像处理的时候需要在很多函数中传递图像，所以需要用到信息头，让每个传递的Mat对象都有自己的信息头，但使用矩阵指针指向同一个地址从而共享一个图像矩阵，这样传递时只会拷贝信息头和矩阵指针，而不是拷贝图像像素指针。</p>
<p>下面使用官方示例代码来学习Mat对象。</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Mat A;                                 // 只创建信息头部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A = imread(&quot;test.jpg&quot;); // 这里为矩阵开辟内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	/*Mat的成员属性data：uchar类型的指针，指向Mat数据矩阵的首地址*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float* A_ptr = (float*)A.data;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;A&quot;,A);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat B(A);                                 // 使用拷贝构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	float* B_ptr = (float*)B.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;B&quot;,B);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Mat C;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	C = A;                                    // 赋值运算符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	float* C_ptr = (float*)C.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout&lt;&lt;&quot;Mat A 矩阵指针:&quot;&lt;&lt;A_ptr&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout&lt;&lt;&quot;Mat B 矩阵指针:&quot;&lt;&lt;B_ptr&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout&lt;&lt;&quot;Mat C 矩阵指针:&quot;&lt;&lt;C_ptr&lt;&lt;endl;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们在初始化Mat对象时，只是创建了信息头，只是申请了一小块内存用于存放矩阵尺寸、存储方法、存储地址等数据。直到使用imread函数读取图像文件后，会为矩阵开辟内存，将图像文件以矩阵数据的方式存放在开辟的内存中。通过打印Mat对象A/B/C的矩阵指针（指向图像矩阵数据的指针），可以发现我们使用拷贝构造函数或者赋值运算符只是新建了一个信息头，信息头指向的图像矩阵数据是一样的，这就说明了传递图像可以减少内存的开销，但是因为是A/B/C都共享一个图像矩阵，那么任何一个对象进行图像数据的修改都会影响到其他对象。</p>
<p>如果你在读取图像时只想获取其中其他对象中的部分图像，可以创建一个信息头引用部分数据。</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Mat D (A, Rect(10, 10, 100, 100) ); // using a rectangle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	float* D_ptr = (float*)D.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;D&quot;,D);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;Mat D 矩阵指针:&quot;&lt;&lt;D_ptr&lt;&lt;endl;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中Rect函数为矩形类，可以在绘制一个矩形框。函数用法：Rect(int x, int y, int width, int height)，其中第一个参数为绘制矩阵的x坐标，第二个参数为绘制矩阵的y坐标，第三个参数为绘制矩阵的宽度，第三个参数为绘制矩阵的高度。例如：</p>
<p>Rect(10, 10, 100, 100)</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231214164353116.png" alt="image=" class="img_ev3q"></p>
<p>通过上图我们可以看到黄色矩形为Rect函数创建出来的矩形，前两个参数xy确定矩阵的位置(绿色点)，通过宽高确定矩形绘制的大小。通过在Mat对象调用该函数可以去创建一个感兴趣区域(ROI)，即提取图片某一区域的图像。</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231214170824529.png" alt="image=" class="img_ev3q"></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Mat E = A(Range::all(), Range(1,30)); // using row and column boundaries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	float* E_ptr = (float*)E.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;E&quot;,E);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;Mat E 矩阵指针:&quot;&lt;&lt;E_ptr&lt;&lt;endl;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Range对象可以用来表示矩阵的多个连续的行或者多个连续的列，其中<code>Range::all(), Range(1,30)</code>，可以提取图像矩阵中第一列到30列（不包括30列）。提取的结果如下所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231214172332824.png" alt="image=" class="img_ev3q"></p>
<p>​	那么一个图像数据矩阵属于那么多的Mat的对象，那么谁来最后负责清理呢？是最后一个使用它的对象，通过引用计数器来实现，无论谁来拷贝Mat对象的信息头，都会增加矩阵的引用次数，反之当一个信息头被释放之后，这个引用计数器就减一，当数值为0时，图像矩阵就会被清理。</p>
<p>​	如果你某些情况需要拷贝图像矩阵本身，而不是信息头和矩阵指针的时候，也就是想使用一个信息图像矩阵存储拷贝过来的图像矩阵，此时就可以使用函数<code>clone()</code>和<code>copyTo()</code>。</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Mat F = A.clone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float* F_ptr = (float*)F.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;Mat F 矩阵指针:&quot;&lt;&lt;F_ptr&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;F&quot;,F);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat G;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A.copyTo(G);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float* G_ptr = (float*)G.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;Mat G 矩阵指针:&quot;&lt;&lt;G_ptr&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;G&quot;,G);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以从打印信息看到，通过函数<code>clone()</code>和<code>copyTo()</code>拷贝的图像矩阵会使用新的矩阵指针指向新的内 存空间。那么此时我们去改变F对象或者G对象就不会影响原来A对象信息头指向的图像数据矩阵。</p>
<p>总结：</p>
<ul>
<li>OpenCV函数中输出图像的内存分配是自动完成的（如果不特别指定的话）。</li>
<li>使用OpenCV的C++接口时不需要考虑内存释放问题。</li>
<li>赋值运算符和拷贝构造函数（ <em>ctor</em> ）只拷贝信息头。</li>
<li>使用函数 <a href="http://opencv.itseez.com/modules/core/doc/basic_structures.html#mat-clone" target="_blank" rel="noopener noreferrer">clone()</a> 或者 <a href="http://opencv.itseez.com/modules/core/doc/basic_structures.html#mat-copyto" target="_blank" rel="noopener noreferrer">copyTo()</a> 来拷贝一副图像的矩阵。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="125-mat图像通道和位深">1.2.5 Mat图像通道和位深<a href="#125-mat图像通道和位深" class="hash-link" aria-label="1.2.5 Mat图像通道和位深的直接链接" title="1.2.5 Mat图像通道和位深的直接链接">​</a></h4>
<p>​	上一小节我们讨论了Mat对象可以作为通用矩阵类和图像容器，那么使用Mat对象去存储图像时，容器中的元素存储的是像素值，在OpenCV中有专门的数据格式来描述这些像素值参数，例如通道数、整型、字符类型等。例如：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Mat Img(640, 640, CV_8UC3);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​	上述代码，我们创建了一个Mat对象作为图像容器，存储的是图像高（行row）640，图像宽（列col）640，存储的数据类型是CV_8UC3。</p>
<p>这里的数据类型CV_8UC3的数据格式为：基本数据类型+通道数。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CV_8UC3数据格式：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CV_:数据前缀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8：比特数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">U：数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C3：通道数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>位深表示每个值由多少位来存储，是一个精度问题，一般图片是8bit（位）的，则深度是8。</p>
<p><strong>比特数(bit_depth)：</strong> 图像中像素点在内存空间所占的内存大小。参数有8bits、16bites、32bites、64bites。</p>
<table><thead><tr><th>数据类型</th><th>说明</th></tr></thead><tbody><tr><td>S</td><td>signed int 有符号整型</td></tr><tr><td>U</td><td>unsigned int 无符号整型</td></tr><tr><td>F</td><td>float 单精度浮点型</td></tr></tbody></table>
<p>通道表示每个点能存放多少个数，类似于RGB彩色图中的每个像素点有三个值，即三通道的。</p>
<table><thead><tr><th>通道</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>灰度图像（单通道图像）</td></tr><tr><td>2</td><td>双通道图像</td></tr><tr><td>3</td><td>RGB图像（3通道图像）</td></tr><tr><td>4</td><td>带Alph通道的RGB图像（4通道图像）</td></tr></tbody></table>
<p>这里的CV_8UC3就表示：每个像素8bit（位）的unsigned int （无符号整型）数据存储RGB(3通道)的像素值。</p>
<p>下面我们来看看常见的数据格式：</p>
<table><thead><tr><th>数据格式</th><th>说明</th></tr></thead><tbody><tr><td>CV_8UC1</td><td>每个像素8bit（位）的unsigned int （无符号整型）数据存储单通道的像素值。</td></tr><tr><td>CV_8UC2</td><td>每个像素8bit（位）的unsigned int （无符号整型）数据存储双通道的像素值。</td></tr><tr><td>CV_8UC3</td><td>每个像素8bit（位）的unsigned int （无符号整型）数据存储三通道的像素值。</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="126-图像通道操作">1.2.6 图像通道操作<a href="#126-图像通道操作" class="hash-link" aria-label="1.2.6 图像通道操作的直接链接" title="1.2.6 图像通道操作的直接链接">​</a></h4>
<p>​	我们端设备上获取图像通常都是3通道的RGB图像，但对于OpenCV默 认使用BGR而非RGB格式来表示图像的颜色通道。这是因为在OpenCV的早期开发阶段，BGR格式在相机制造厂商和软件提供商之间比较受欢迎。</p>
<p>​	对于多通道的图像我们在图像处理操作中可能会将图像分段存储，这需要涉及到通道的分离和合并。例如我们需要将图像拆分不同的通道，并对每个通道进行填充以达到模型输入对应尺寸。那么下面我们来介绍通道处理中的通道合并和通道分离。</p>
<p>​	<strong>通道分离函数-split函数</strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void cv::split(InputArray m, OutputArrayOfArrays mv);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li>InputArray m ：为需要进行分离的多通道数据，一般填入Mat对象。</li>
<li>OutputArrayOfArrays mv ：为函数输出的数组，一般填入Vector容器。</li>
</ul>
<p>示例程序：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cv::split(Mat Img,Vecotr&lt;Mat&gt; Ori);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​	<strong>通道合并函数-merge</strong></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void cv::merge(const vector&amp; mv, OutputArray dst );</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​	参数  说明：</p>
<ul>
<li>const vector&amp; mv：图像矩阵向量Vector容器。</li>
<li>OutputArray dst：输出图像Mat对象。</li>
</ul>
<p>示例程序：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cv::merge(Vecotr&lt;Mat&gt; Ori, Mat dstImg );</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面通过摄像头获取到图像后，将图像进行拆分后再进行合并，学习通道分离和合并函数，如下所示：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include&lt;opencv2/opencv.hpp&gt; //包含opencv库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace cv;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace std;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat img = imread(&quot;test.jpg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat res;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resize(img, res, Size(640, 480));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;Mat&gt; ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    split(res,ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;OpenCV Version:&quot;&lt;&lt;CV_VERSION&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //读取视频或摄像头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	VideoCapture capture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.open(&quot;/dev/video0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //capture.open(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!capture.isOpened())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;open video0 success!!&quot;&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int cap_width = capture.get(CAP_PROP_FRAME_WIDTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int cap_height = capture.get(CAP_PROP_FRAME_HEIGHT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;capture width:&quot;&lt;&lt;cap_width&lt;&lt;&quot;capture height:&quot;&lt;&lt;cap_height&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FRAME_WIDTH, cap_width);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FRAME_HEIGHT, cap_height);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.set(CAP_PROP_FOURCC, VideoWriter::fourcc(&#x27;M&#x27;, &#x27;J&#x27;, &#x27;P&#x27;, &#x27;G&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namedWindow(&quot;capture&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	while (true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Mat frame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		capture &gt;&gt; frame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (frame.empty())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imshow(&quot;capture&quot;, frame);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;Mat&gt; ori_cam;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        split(frame,ori_cam);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imshow(&quot;blue channel&quot;,ori_cam[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //imshow(&quot;green channel&quot;,ori_cam[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //imshow(&quot;red channel&quot;,ori_cam[2]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_cam.erase(ori_cam.begin() + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_cam.insert(ori_cam.begin() + 1,ori_img[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mat dstFrame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        merge(ori_cam,dstFrame);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imshow(&quot;dstFrame&quot;,dstFrame);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (&#x27;q&#x27; == waitKey(10)) {			//&#x27;q&#x27;退出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //释放窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::destroyAllWindows();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capture.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>本程序先将本地图片分为三个颜色通道，并存入Vector容器。然后读取摄像头数据，也分为三个通道，再用本地图片的G通道替换摄像头数据的G通道，最后显示出来。程序的具体流程如下所示：</p>
<ul>
<li>读取本地图像并修改分辨率</li>
<li>使用split函数拆分原图像的通道数据存放到Vector容器</li>
<li>读取视频或摄像头并设置摄像头参数</li>
<li>读取摄像头数据并将图像数据拆分通道数据存放在Vector容器</li>
<li>删除视频通道数据Vector容器中的G通道数据并将本地图像中的G通道数据填入Vector容器中</li>
<li>使用merge函数函数融合Vector容器中的数据并显示出来。</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20240118193521005.png" alt="image=" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="127-图像处理常用函数-几何变换">1.2.7 图像处理常用函数-几何变换<a href="#127-图像处理常用函数-几何变换" class="hash-link" aria-label="1.2.7 图像处理常用函数-几何变换的直接链接" title="1.2.7 图像处理常用函数-几何变换的直接链接">​</a></h4>
<p>OpenCV 几何变换是指对图像进行一些基本的空间变换，如缩放、平移、旋转、仿射和透视等。这些变换可以用矩阵运算来表示，OpenCV 提供了一些函数来方便地实现这些变换。例如：</p>
<ul>
<li><code>cv::resize</code> 可以对图像进行缩放，可以指定输出图像的尺寸或者缩放比例，以及插值方法。</li>
<li><code>cv::warpAffine</code> 可以对图像进行仿射变换，需要指定一个 2×3 的变换矩阵，以及输出图像的大小。</li>
<li><code>cv::getRotationMatrix2D</code> 可以生成一个旋转变换矩阵，需要指定旋转中心、旋转角度和缩放比例。</li>
<li><code>cv::flip</code>可以实现图像的水平或垂直方向的翻转。</li>
</ul>
<p>下面我们通过一个程序来讲解OpenCV如何实现图像的几何变换，如下所示：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/opencv.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace cv;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat img = imread(&quot;test.jpg&quot;); // 读取图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;Original&quot;, img); // 显示原图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat res;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resize(img, res, Size(300, 300)); // 将图像缩放到 300x300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;Resized&quot;, res); // 显示缩放后的图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //旋转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat M_rev = getRotationMatrix2D(Point2f(img.cols/2, img.rows/2), 45, 0.8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 应用仿射变换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat rev_dst;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    warpAffine(img, rev_dst, M_rev, img.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;Affine&quot;, rev_dst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //平移</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取图像的高度和宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int rows = img.rows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int cols = img.cols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 生成平移矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat M_ts = getRotationMatrix2D(Point2f(0, 0), 0, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M_ts.at&lt;double&gt;(0, 2) = 50; // x轴偏移量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M_ts.at&lt;double&gt;(1, 2) = 100; // y轴偏移量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 应用平移变换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat ts_dst;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    warpAffine(img, ts_dst, M_ts, cv::Size(cols, rows));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //展示将图像沿x轴移动50像素，沿y轴移动100像素</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;Translate&quot;, ts_dst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mat flip_dst;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 水平翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flip(img, flip_dst, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imshow(&quot;flip&quot;, flip_dst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    waitKey(0); // 等待按键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destroyAllWindows(); // 关闭窗口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>程序运行后分别会展示原始图像/缩放图像/旋转图像/平移图像/翻转图像。如下图所示：</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20240118193854748.png" alt="image=" class="img_ev3q"></p>
<p>下面我们分别来看程序中的缩放/旋转/平移/翻转是如何实现的。通过程序来看图像的缩放是通过resize函数实现的，它是OpenCV中的一个函数，用于对图像进行缩放或调整大小。它可以根据给定的宽度和高度，或者根据给定的缩放因子，来改变图像的尺寸。它还可以根据不同的插值方法，来保证图像的质量和效果。cv::resize的函数原型如下：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void cv::resize(InputArray src, OutputArray dst, Size dsize, double fx = 0, double fy = 0, int interpolation = INTER_LINEAR)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li>src：输入图像，可以是任意类型和通道数的Mat对象</li>
<li>dst：输出图像，与输入图像有相同的类型，但大小由dsize参数指定，或者由fx和fy参数计算</li>
<li>dsize：输出图像的大小，如果为零，则根据fx和fy参数的值来确定</li>
<li>fx：水平方向的缩放因子，如果为零，则根据dsize参数的值来确定</li>
<li>fy：垂直方向的缩放因子，如果为零，则根据dsize参数的值来确定</li>
<li>interpolation：插值方法，常用的有以下几种：<!-- -->
<ul>
<li>INTER_NEAREST：最近邻插值，速度最快，但效果最差</li>
<li>INTER_LINEAR：双线性插值，速度较快，效果较好，是默认的插值方法</li>
<li>INTER_AREA：区域插值，适用于图像缩小，可以避免波纹现象</li>
<li>INTER_CUBIC：双三次插值，适用于图像放大，效果最好，但速度最慢</li>
<li>INTER_LANCZOS4：Lanczos插值，一种高级的插值方法，可以产生更好的图像质量，但速度更慢</li>
</ul>
</li>
</ul>
<p>我们经过了一个resize函数可以将原图缩小成300×300像素大小的图像，resize函数不仅可以缩小图像，也可以放大图像，只要指定合适的dsize参数或者fx和fy参数。resize函数可以根据不同的插值方法，来保证图像的质量和效果，例如，如果你想放大图像，你可以使用INTER_CUBIC或者INTER_LANCZOS4来得到更好的结果。resize函数可以处理任意类型和通道数的图像，例如，你可以对彩色图像、灰度图像、二值图像等进行缩放或调整大小。</p>
<p>​	对于旋转和平移都可以通过仿射变换来实现，那么 我们先来看什么是仿射变换？仿射变换是指在几何中，对一个向量空间进行一次线性变换并接上一个平移，变换为另一个向量空间。简单来说，就是“线性变换”+“平移”。仿射变换保持了直线的平行性和比例，但不一定保持角度和距离。</p>
<p>仿射变换可以用矩阵和向量来表示，例如：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mi>e</mi><mi>c</mi><mi>y</mi><mo>=</mo><mi>A</mi><mi>v</mi><mi>e</mi><mi>c</mi><mi>x</mi><mo>+</mo><mi>v</mi><mi>e</mi><mi>c</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">vec {y}=Avec {x}+vec {b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">ec</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">ec</span><span class="mord"><span class="mord mathnormal">x</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">ec</span><span class="mord"><span class="mord mathnormal">b</span></span></span></span></span></span>
<p>其中，A是一个线性变换矩阵，vecb是一个平移向量，vecx和vecy是变换前后的向量。</p>
<p>总的来说就是使用原来的图像矩阵乘一个矩阵，从而实现图像的旋转和缩放。具体可以参考OpenCV官方文档：<a href="https://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/imgproc/imgtrans/warp_affine/warp_affine.html" target="_blank" rel="noopener noreferrer">仿射变换 — OpenCV 2.3.2 documentation</a></p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20240118152845662.png" alt="image=" class="img_ev3q"></p>
<p><code>getRotationMatrix2D</code>是用于生成一个2x3的仿射变换矩阵，该矩阵可以用于对图像进行旋转和缩放操作。该函数的语法如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Mat cv</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getRotationMatrix2D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Point2f center</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> angle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> scale</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li>center：旋转的中心点，可以是图像的中心或任意点</li>
<li>angle：旋转的角度，单位为度，正值表示逆时针旋转，负值表示顺时针旋转</li>
<li>scale：缩放的比例，大于1表示放大，小于1表示缩小，等于1表示不变</li>
</ul>
<p><code>warpAffine</code>是OpenCV中的一个函数，用于对图像进行仿射变换。仿射变换是一种图像的几何变换，它可以对图像进行旋转、缩放、平移、翻转、错切等操作，但必须保持图像的平行性。warpAffine函数的语法如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> cv</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">warpAffine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">InputArray src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OutputArray dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InputArray M</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Size dsize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> INTER_LINEAR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> borderMode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BORDER_CONSTANT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Scalar </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> borderValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Scalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li>src：输入图像，可以是任意类型和通道数的Mat对象</li>
<li>dst：输出图像，与输入图像有相同的类型，但大小由dsize参数指定</li>
<li>M：2x3的变换矩阵，可以用cv::getAffineTransform或cv::getRotationMatrix2D来生成，或者自己构造一个数组</li>
<li>dsize：输出图像的大小，如果为零，则根据src的大小和M的值计算</li>
<li>flags：插值方法，常用的有cv::INTER_LINEAR（双线性插值）和cv::INTER_NEAREST（最近邻插值）</li>
<li>borderMode：边界处理方式，常用的有cv::BORDER_CONSTANT（用常数填充）和cv::BORDER_REPLICATE（用边界像素复制）</li>
<li>borderValue：当borderMode为cv::BORDER_CONSTANT时，用于填充的常数值，默认为0</li>
</ul>
<p>​	对于图像旋转，我们用getRotationMatrix2D函数，以图像中心点（由Point2f创建）为旋转中心，创建一个逆时针旋转45度，缩放比例为0.7的仿射矩阵。然后，我们用warpAffine函数，把这个矩阵和输入图像一起传入，得到变换后的输出图像。</p>
<p>​	对于图像平移，我们通过改变变换矩阵的x轴和y轴分量，实现了图像的平移，而不改变其旋转和缩放。图像的平移是通过调整变换矩阵在x轴和y轴上的偏移来完成的，不涉及旋转和缩放的变化。为了平移图 像，我们只需修改变换矩阵的x轴和y轴偏移，不用改变其旋转和缩放。</p>
<p><img loading="lazy" src="http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20240118162002185.png" alt="image=" class="img_ev3q"></p>
<p>对于图像翻转就可以通过cv::flip()方法，它可以用来翻转二维数组的。这个函数可以根据不同的参数，在垂直、水平或者两个轴上翻转图像。语法如下：</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cv::flip(src, dst, flipCode)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li>src: 输入数组，可以是图像或者矩阵。</li>
<li>dst: 输出数组，和src的大小和类型相同。</li>
<li>flipCode: 一个标志，指定如何翻转数组；0表示沿着x轴翻转，正值（例如，1）表示沿着y轴翻转。负值（例如，-1）表示沿着两个轴翻转。</li>
</ul>
<p>返回值：</p>
<ul>
<li>它返回一个翻转后的图像数组。</li>
</ul>
<p>我们使用flip函数主要传入输入图像，输出图像以及沿着x轴或者y轴翻转，执行完成后即可得到 输出图像。</p>
<p>本节主要介绍OpenCV的几何变换方法，让大家感受opencv的开发流程，学习图像变换的基础操作。opencv提供了多种几何变换方法，包括图像的翻转、平移、旋转、仿射和透视变换。图像的几何变换就是将一组图像数据经过某种数学运算，映射成另外一组图像数据的操作，其关键是确定空间映射关系，一般用变换矩阵来表示。opencv提供了cv2.warpAffine和cv2.warpPerspective两个函数来实现几何变换，前者用于仿射变换，后者用于透视变换，它们都需要指定变换矩阵、输出图像大小和插值方法。插值方法是指在图像缩放或旋转时，如何填充或删去一些像素值，opencv提供了多种插值方法，如最近邻插值、双线性插值、双三次插值、区域插值等，它们对图像的质量和速度有不同的影响。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/eLinuxAI-TrainingDocs/tree/main/docs/ELinuxAIBase/05-DataLayer-DataAcquisition.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/ELinuxAIBase/EdgeDeployment"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">8.边缘部署</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ELinuxAIBase/ModelLayerAndComputingPowerLayer"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">10.模型层和算力层</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11-视频数据采集-v4l2" class="table-of-contents__link toc-highlight">1.1 视频数据采集-V4L2</a></li><li><a href="#12-控制流程" class="table-of-contents__link toc-highlight">1.2 控制流程</a></li><li><a href="#13-编写app" class="table-of-contents__link toc-highlight">1.3 编写APP</a></li><li><a href="#2-数据层-数据预处理" class="table-of-contents__link toc-highlight">2. 数据层-数据预处理</a><ul><li><a href="#11-opencv计算机视觉库" class="table-of-contents__link toc-highlight">1.1 OpenCV计算机视觉库</a></li><li><a href="#12-opencv入门" class="table-of-contents__link toc-highlight">1.2 OpenCV入门</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>