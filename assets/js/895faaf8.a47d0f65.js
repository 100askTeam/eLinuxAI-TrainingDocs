"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4363],{73133:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>a,default:()=>_,frontMatter:()=>s,metadata:()=>d,toc:()=>c});var r=t(85893),i=t(11151);const s={sidebar_position:5},a="5.AI\u5e94\u7528\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",d={id:"CanaanK510/AI-ApplicationFrameworkAnalysis",title:"5.AI\u5e94\u7528\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",description:"12.1 AI\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u6d41\u6846\u56fe",source:"@site/docs/CanaanK510/12-AI-ApplicationFrameworkAnalysis.md",sourceDirName:"CanaanK510",slug:"/CanaanK510/AI-ApplicationFrameworkAnalysis",permalink:"/CanaanK510/AI-ApplicationFrameworkAnalysis",draft:!1,unlisted:!1,editUrl:"https://github.com/100askTeam/eLinuxAI-TrainingDocs/tree/main/docs/CanaanK510/12-AI-ApplicationFrameworkAnalysis.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"calsspartoneSidebar",previous:{title:"4.\u8bad\u7ec3\u81ea\u5b9a\u4e49\u6a21\u578b\u90e8\u7f72",permalink:"/CanaanK510/TrainACustomModelDeployment"},next:{title:"\u66f4\u591a\u5609\u6960\u6a21\u578b\u90e8\u7f72\u5b9e\u6218",permalink:"/category/\u66f4\u591a\u5609\u6960\u6a21\u578b\u90e8\u7f72\u5b9e\u6218"}},o={},c=[{value:"12.1 AI\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u6d41\u6846\u56fe",id:"121-ai\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u6d41\u6846\u56fe",level:3},{value:"12.2 \u9605\u8bfb\u7aef\u4fa7\u63a8\u7406\u6a21\u578b\u793a\u4f8b",id:"122-\u9605\u8bfb\u7aef\u4fa7\u63a8\u7406\u6a21\u578b\u793a\u4f8b",level:3},{value:"12.3 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",id:"123-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",level:3},{value:"12.4 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790-AI\u5de5\u4f5c",id:"124-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790-ai\u5de5\u4f5c",level:3},{value:"12.5 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790- display_work",id:"125-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790--display_work",level:3},{value:"12.6 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790- DRM\u663e\u793a\u51fd\u6570process_ds0_image",id:"126-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790--drm\u663e\u793a\u51fd\u6570process_ds0_image",level:3}];function l(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.a)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"5ai\u5e94\u7528\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",children:"5.AI\u5e94\u7528\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790"}),"\n",(0,r.jsx)(e.h3,{id:"121-ai\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u6d41\u6846\u56fe",children:"12.1 AI\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u6d41\u6846\u56fe"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155117172.png",alt:"image-20231012155117172"})}),"\n",(0,r.jsx)(e.h3,{id:"122-\u9605\u8bfb\u7aef\u4fa7\u63a8\u7406\u6a21\u578b\u793a\u4f8b",children:"12.2 \u9605\u8bfb\u7aef\u4fa7\u63a8\u7406\u6a21\u578b\u793a\u4f8b"}),"\n",(0,r.jsxs)(e.p,{children:["\u6253\u5f00nncase\u5f00\u53d1\u6587\u6863\u7f51\u5740\uff1a",(0,r.jsx)(e.a,{href:"https://canaan-docs.100ask.net/Application/AIApplicationDevelopment-Canaan/05-nncase_Developer_Guides.html",children:"https://canaan-docs.100ask.net/Application/AIApplicationDevelopment-Canaan/05-nncase_Developer_Guides.html"})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155157720.png",alt:"image-20231012155157720"})}),"\n",(0,r.jsx)(e.h3,{id:"123-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790",children:"12.3 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u6846\u67b6\u89e3\u6790"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155222724.png",alt:"image-20231012155222724"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6ce8\u610f\uff1a"})}),"\n",(0,r.jsx)(e.p,{children:"\u200b    1.AI\u5de5\u4f5c\u53ea\u4f5c\u753b\u6846\u548c\u7ed8\u5236\u9884\u6d4b\u7c7b\u522b\u4f5c\u7528\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u200b    2.\u663e\u793a\u5de5\u4f5c\u53ea\u4f5c\u663e\u793a\u5c4f\u4e0a\u663e\u793a\u5de5\u4f5c\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"124-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790-ai\u5de5\u4f5c",children:"12.4 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790-AI\u5de5\u4f5c"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"1.\u521b\u5efa\u7c7b"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"// \u521b\u5efa\u4e00\u4e2a\u76ee\u6807\u68c0\u6d4b\u7c7b \nobjectDetect od(obj_thresh, nms_thresh, net_len, {valid_width, valid_height});\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u76ee\u6807\u68c0\u6d4b\u7c7b\u5c5e\u4e8eSimulator\u7c7b, \u7528\u4e8e\u5728PC\u4e0a\u63a8\u7406kmodel"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"\u76ee\u7684\uff1a\u521b\u5efa\u8fd9\u4e2a\u7c7b\uff0c\u7528\u4e8e\u51c6\u5907\u5185\u5b58\u3001\u52a0\u8f7d\u6a21\u578b\uff0c\u8bbe\u7f6e\u6a21\u578b\u7684\u8f93\u5165\u8f93\u51fa\u3001\u6a21\u578b\u7684\u63a8\u7406\u3001\u540e\u5904\u7406\u7b49\u529f\u80fd\u3002\u5728\u8fd9\u4e2a\u7c7b\u7684public\u4e2d\u5b9a\u4e49\u529f\u80fd\u51fd\u6570\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u4e0b\u9762\u4e3a\u76ee\u6807\u68c0\u6d4b\u90e8\u5206\u5b9a\u4e49\u622a\u56fe\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"// \u76ee\u6807\u68c0\u6d4b\u7c7b\u5b9a\u4e49\uff08\u90e8\u5206\uff09\nclass objectDetect\n{\npublic:\n\xa0 \xa0 objectDetect(float obj_thresh, float nms_thresh, int net_len, Framesize frame_size);\n\xa0 \xa0 void prepare_memory();\n\xa0 \xa0 void set_input(uint32_t index);\n\xa0 \xa0 void set_output();\n\xa0 \xa0 void load_model(char *path);\n\xa0 \xa0 void run();\n\xa0 \xa0 void get_output();\n\xa0 \xa0 void post_process(std::vector<BoxInfo> &result);\n\xa0 \xa0 ~objectDetect();\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"2.\u52a0\u8f7d\u6a21\u578b"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"od.load_model(kmodel_path); \xa0// load kmodel\uff08\u52a0\u8f7d\u6a21\u578b\uff09\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u51fd\u6570\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'void objectDetect::load_model(char *path)\n{\n\xa0 \xa0 od_model = read_binary_file<unsigned char>(path); // \u8bfb\u53d6\u4f20\u5165\u7684\u5730\u5740\u4e2d\u7684\u6a21\u578b\u6587\u4ef6\n\xa0 \xa0 interp_od.load_model({ (const gsl::byte *)od_model.data(), od_model.size() }).expect("cannot load model.");\n\xa0 \xa0 std::cout << "============> interp_od.load_model finished!" << std::endl;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"3.\u51c6\u5907\u5185\u5b58"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"Od.prepare_memory(); // memory allocation\uff08\u51c6\u5907\u5185\u5b58\uff09\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u622a\u53d6\u4ee3\u7801prepare_memory\u5b9a\u4e49\u4e2d\u7684\u91cd\u8981\u7247\u6bb5\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"virtual_addr_output = (char *)mmap(NULL, allocAlignMemOdOutput.size, PROT_READ | PROT_WRITE, MAP_SHARED, mem_map, allocAlignMemOdOutput.phyAddr);\n\nvirtual_addr_input[i] = (char *)mmap(NULL, allocAlignMemOdInput[i].size, PROT_READ | PROT_WRITE, MAP_SHARED, mem_map, allocAlignMemOdInput[i].phyAddr);\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u4ee3\u7801\u7406\u89e3\uff1a\u5185\u6838\u7533\u8bf7\u4e00\u5757\u5171\u4eab\u5185\u5b58\u4f9b\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\uff0c\u8fd9\u5757\u5185\u5b58\u7684\u5730\u5740\u79f0\u4e3a\u865a\u62df\u5730\u5740\u3002\u5916\u90e8\u5e94\u7528\u60f3\u4f7f\u7528\u8fd9\u5757\u5185\u5b58\u4ec5\u9700\u8981\u53bb\u8c03\u7528\u8fd9\u5757\u865a\u62df\u5185\u5b58\u5373\u53ef\u3002\u865a\u62df\u5730\u5740virtual_addr_input\u4e2d\u5305\u542b\u4e86\u6307\u5411\u5171\u4eab\u5185\u5b58\u7684\u6307\u9488\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155506083.png",alt:"image-20231012155506083"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"4.VideoCapture\u83b7\u5f97\u6444\u50cf\u5934\u6570\u636e"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"mtx.lock(); //\u83b7\u5f97\u9501\uff08\u83b7\u5f97\u72ec\u5360\u5f0f\u8d44\u6e90\u7684\u80fd\u529b\uff09\ncv::VideoCapture capture; //\u4f7f\u7528OpenCV\u521b\u5efa\u4e00\u4e2acapture\u7c7b\uff0c\u7528\u4e8e\u8c03\u7528\u6444\u50cf\u5934\ncapture.open(5);//\u6253\u5f00/dev/video5\u8282\u70b9\n// video setting\ncapture.set(cv::CAP_PROP_CONVERT_RGB, 0); //\u4e0d\u5c06\u6355\u83b7\u7684\u56fe\u50cf\u8f6c\u6362\u4e3aRGB\ncapture.set(cv::CAP_PROP_FRAME_WIDTH, net_len); //\u8bbe\u7f6e\u6355\u83b7\u89c6\u9891\u5bbd\u4e3a\u6a21\u578b\u5bbd\ncapture.set(cv::CAP_PROP_FRAME_HEIGHT, net_len); //\u8bbe\u7f6e\u6355\u83b7\u89c6\u9891\u9ad8\u4e3a\u6a21\u578b\u9ad8\n// RRRRRR....GGGGGGG....BBBBBB, CHW\ncapture.set(cv::CAP_PROP_FOURCC, V4L2_PIX_FMT_RGB24); //\u83b7\u53d6\u539f\u6765\u7684\u683c\u5f0f\uff0c\u5c06\u539f\u6765\u7684\u683c\u5f0f\u8f6c\u6362\u4e3aRGB24\u56fe\u50cf\nmtx.unlock(); //\u91ca\u653e\u9501\n\ncv::Mat rgb24_img_for_ai(net_len, net_len, CV_8UC3, od.virtual_addr_input[0] + (net_len - valid_width) / 2 + (net_len - valid_height) / 2 * net_len);//\u521b\u5efaMat\u6570\u636e\u7c7b\u578b\uff0c\u7528\u4e8e\u5b58\u50a8\u56fe\u50cf\u6570\u636e\uff0c\u5b58\u653e\u4f4d\u7f6e\u4f4d\u4e8e\u865a\u62df\u5730\u5740\uff08\u5171\u4eab\u5185\u5b58\uff09\u4e2d\nret = capture.read(rgb24_img_for_ai); //\u8bfb\u53d6\u89c6\u9891\u56fe\u50cf\uff0c\u5e76\u5c06\u56fe\u50cf\u6570\u636e\u5b58\u653e\u5728\u5171\u4eab\u5185\u5b58\u4e2d\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155528834.png",alt:"image-20231012155528834"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"5.\u5bfb\u627e3\u901a\u9053\u5730\u5740"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"//padding\nuint8_t *r_addr, *g_addr, *b_addr;\ng_addr = (uint8_t *)od.virtual_addr_input[0] + offset_channel;\nr_addr = is_rgb ? g_addr - offset_channel : g_addr + offset_channel;\nb_addr = is_rgb ? g_addr + offset_channel : g_addr - offset_channel;\n"})}),"\n",(0,r.jsx)(e.p,{children:"od.virtual_addr_input[0]\u4e3a\u56fe\u50cf\u6570\u636e\u7684\u9996\u5730\u5740\uff0c\u90a3\u4e48RGB\u56fe\u50cf\u6216BGR\u56fe\u50cf\uff0c\u5c31\u53ef\u77e5\u90533\u901a\u9053\u4e2d\u7684\u4e2d\u95f4\u901a\u9053G\u7684\u5730\u5740"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155551482.png",alt:"image-20231012155551482"})}),"\n",(0,r.jsx)(e.p,{children:"\u77e5\u90533\u901a\u9053BGR\u4e2d\u7684\u4e2d\u95f4\u901a\u9053G\u7684\u5730\u5740\u540e\uff0c\u6c42\u5269\u4e0b\u4e24\u901a\u9053\u7684\u5730\u5740\uff0c\u4e0b\u9762\u4e3a\u6c42\u89e3rgb\u4e09\u901a\u9053\u7684\u5404\u4e2a\u5730\u5740\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155603431.png",alt:"image-20231012155603431"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"6.\u586b\u5145\u56fe\u50cf"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"//gnne_input_width\uff1a\u6a21\u578b\u5bbd\u5ea6 320 gnne_valid_width\uff1a\u89c6\u9891\u8f93\u5165\u5bbd\u5ea6 240\nif (gnne_valid_width < gnne_input_width) {\t\n\xa0 \xa0 uint32_t padding_r = (gnne_input_width - gnne_valid_width); //\u8ba1\u7b97\u603b\u5171\u9700\u8981\u586b\u5145\u7684\u5927\u5c0f\n\xa0 \xa0 uint32_t padding_l = padding_r / 2; //\u8ba1\u7b97\u5de6\u8fb9\u9700\u8981\u586b\u5145\u7684\u5927\u5c0f\n\xa0 \xa0 uint32_t row_offset = (gnne_input_height - gnne_valid_height) / 2; //\u8ba1\u7b97\u4e0b\u4e00\u4e2a\u9700\u8981\u586b\u5145\u7684\u504f\u79fb\u503c\n\xa0 \xa0 padding_r -= padding_l; //\u8ba1\u7b97\u53f3\u8fb9\u9700\u8981\u586b\u5145\u7684\u5927\u5c0f\n\xa0 \xa0 for (int row = row_offset; row < row_offset + gnne_valid_height/*30+240*/; row++) {\n\xa0 \xa0 \xa0 uint32_t offset_l = row * gnne_input_width; //\u8ba1\u7b97\u4e0b\u4e00\u4e2a\u5de6\u8fb9\u9700\u8981\u586b\u5145\u7684\u504f\u79fb\u503c\n\xa0 \xa0 \xa0 uint32_t offset_r = offset_l + gnne_valid_width + padding_l; //\u8ba1\u7b97\u4e0b\u4e00\u4e2a\u53f3\u8fb9\u9700\u8981\u586b\u5145\u7684\u504f\u79fb\u503c\n\xa0 \xa0 \xa0 memset(r_addr + offset_l, PADDING_R, padding_l); //\u586b\u5145\u5de6\u8fb9R\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 memset(g_addr + offset_l, PADDING_G, padding_l); //\u586b\u5145\u5de6\u8fb9G\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 memset(b_addr + offset_l, PADDING_B, padding_l); //\u586b\u5145\u5de6\u8fb9B\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 memset(r_addr + offset_r, PADDING_R, padding_r); //\u586b\u5145\u53f3\u8fb9R\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 memset(g_addr + offset_r, PADDING_G, padding_r); //\u586b\u5145\u53f3\u8fb9G\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 memset(b_addr + offset_r, PADDING_B, padding_r); //\u586b\u5145\u53f3\u8fb9B\u901a\u9053\uff0c\u586b\u5145\u503c\u4e3a114\uff08\u7070\u5ea6\u503c\uff09\uff0c\u586b\u5145\u8303\u56f4\n\xa0 \xa0 \xa0 \xa0}\n}\n\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155715278.png",alt:"image-20231012155715278"})}),"\n",(0,r.jsx)(e.p,{children:"\u5b9e\u9645\u56fe\u50cf\u5982\u4e0b\u6240\u6240\u793a\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155732820.png",alt:"image-20231012155732820"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"7.\u8bbe\u7f6e\u8f93\u5165\u77e9\u9635"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"od.set_input(0); //\u8bbe\u7f6e\u8f93\u5165\u77e9\u9635\n"})}),"\n",(0,r.jsx)(e.p,{children:"Object_detect\u7a0b\u5e8f\u4e2dset_input\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"void objectDetect::set_input(uint32_t index)\n{\n\xa0 \xa0auto in_shape = interp_od.input_shape(0); //\u8bbe\u7f6e\u8f93\u5165\u77e9\u9635\u7684shape\xa0 \xa0auto input_tensor = host_runtime_tensor::create(dt_uint8, //\u8bbe\u7f6e\u6570\u636e\u7c7b\u578b\n       in_shape, //\u8bbe\u7f6etensor\u7684\u5f62\u72b6\n\t//\u8bbe\u7f6e\u7528\u6237\u6001\u6570\u636e\uff08\u5b58\u653e\u8f93\u5165\u6570\u636e\uff09\n\xa0 \xa0 \xa0 \xa0{ (gsl::byte *)virtual_addr_input[index], net_len * net_len * INPUT_CHANNELS}, \xa0 \xa0 \xa0 \xa0\n\tfalse, //\u662f\u5426\u62f7\u8d1d \n       hrt::pool_shared, //\u5185\u5b58\u6c60\u7c7b\u578b\uff0c\u4f7f\u7528\u7684\u662f\u5171\u4eab\u5185\u5b58\u6c60\n       allocAlignMemOdInput[index].phyAddr).expect(\u201ccannot create input tensor\u201d); //\u5171\u4eab\u5185\u5b58\u7684\u7269\u7406\u5730\u5740\n\xa0 \xa0 interp_od.input_tensor(0, input_tensor).expect(\u201ccannot set input tensor\u201d); //\u8bbe\u7f6e\u8f93\u5165\u7684\u77e9\u9635\n}\n\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155815092.png",alt:"image-20231012155815092"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"8.\u8bbe\u7f6e\u8f93\u51fa\u77e9\u9635"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"od.set_output();//\u8bbe\u7f6e\u8f93\u51fa\u77e9\u9635\n"})}),"\n",(0,r.jsx)(e.p,{children:"Object_detect\u7a0b\u5e8f\u4e2dset_output\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-C++",children:"void objectDetect::set_output()\n{\n\xa0 \xa0 for (size_t i = 0; i < interp_od.outputs_size(); i++)\n\xa0 \xa0 {\n\xa0 \xa0 \xa0 \xa0auto out_shape = interp_od.output_shape(i); //\u8bbe\u7f6e\u8f93\u51fa\u77e9\u9635\u7684shape\n\xa0 \xa0 \xa0 \xa0auto output_tensor = host_runtime_tensor::create(dt_float32, //\u8bbe\u7f6e\u6570\u636e\u7c7b\u578b\n           out_shape, //\u8bbe\u7f6etensor\u7684\u5f62\u72b6\n\xa0 \xa0 \xa0 \xa0    {(gsl::byte *)virtualAddrOdOutput[i], output_size[i]}, //\u8bbe\u7f6e\u7528\u6237\u6001\u6570\u636e\uff08\u5b58\u653e\u8f93\u51fa\u6570\u636e\uff09\n\xa0 \xa0 \xa0 \xa0    false, //\u662f\u5426\u62f7\u8d1d \n           hrt::pool_shared, output_pa_addr[i]).expect(\u201ccannot create output tensor\u201d); //\u5171\u4eab\u5185\u5b58\u7684\u7269\u7406\u5730\u5740\n           interp_od.output_tensor(i, output_tensor).expect(\u201ccannot set output tensor\u201d); //\u8bbe\u7f6e\u8f93\u51fa\u7684\u77e9\u9635\n\xa0 \xa0 }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155858016.png",alt:"image-20231012155858016"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"9.\u8fd0\u884c\u6a21\u578b\u63a8\u7406"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"od.run(); //\u8fd0\u884ckmodel\u63a8\u7406\n"})}),"\n",(0,r.jsx)(e.p,{children:"Object_detect\u7a0b\u5e8f\u4e2drun\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'void objectDetect::run()\n{\n\xa0 \xa0 interp_od.run().expect("error occurred in running model"); //\u8fd0\u884ckmodel\u63a8\u7406\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012155938420.png",alt:"image-20231012155938420"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6ce8\u610f\uff1a"})}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u8fd0\u884ckmodel\u63a8\u7406\u524d\uff0c\u6211\u4eec\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u8f93\u5165\u77e9\u9635\u548c\u8f93\u51fa\u77e9\u9635\u7684\u5b58\u653e\u5730\u5740\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u8bbf\u95ee\u5b58\u653e\u5730\u5740\uff0c\u62f7\u8d1d\u51fa\u6765\u4f7f\u7528\u5373\u53ef\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"10.\u83b7\u53d6\u63a8\u7406\u7ed3\u679c"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"od.get_output(); //\u83b7\u53d6\u63a8\u7406\u540e\u7684\u8f93\u51fa\u7ed3\u679c\n"})}),"\n",(0,r.jsx)(e.p,{children:"Object_detect\u7a0b\u5e8f\u4e2dget_output\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"void objectDetect::get_output()\n{\n\xa0 \xa0 output_0 = reinterpret_cast<float *>(virtualAddrOdOutput[0]);\n\xa0 \xa0 output_1 = reinterpret_cast<float *>(virtualAddrOdOutput[1]);\n\xa0 \xa0 output_2 = reinterpret_cast<float *>(virtualAddrOdOutput[2]);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u63d0\u793a\uff1a"})," reinterpret_cast\u7528\u4e8e\u8fdb\u884c\u5404\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6307\u9488\u4e4b\u95f4\u3001\u4e0d\u540c\u7c7b\u578b\u7684\u5f15\u7528\u4e4b\u95f4\u4ee5\u53ca\u6307\u9488\u548c\u80fd\u5bb9\u7eb3\u6307\u9488\u7684\u6574\u6570\u7c7b\u578b\u4e4b\u95f4\u7684\u8f6c\u6362\u3002\u8f6c\u6362\u65f6\uff0c\u6267\u884c\u7684\u662f\u9010\u4e2a\u6bd4\u7279\u590d\u5236\u7684\u64cd\u4f5c\u3002"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160048382.png",alt:"image-20231012160048382"})}),"\n",(0,r.jsx)(e.p,{children:"**\u6ce8\u610f\uff1a**\u5c06\u8f93\u51fa\u77e9\u9635\u62f7\u8d1d\u5230objectDetect\u7c7b\u4e2d\u7684\u79c1\u6709\u6210\u5458\u53d8\u91cf\u4e2d"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"11.\u540e\u5904\u7406"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"od.post_process(result); //\u540e\u5904\u7406\n"})}),"\n",(0,r.jsx)(e.p,{children:"Object_detect\u7a0b\u5e8f\u4e2dget_output\u5b9a\u4e49\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"void objectDetect::post_process(std::vector<BoxInfo> &result)\n{\n\xa0 \xa0 auto boxes0 = decode_infer(output_0, net_len, 8, classes_num, frame_size, anchors_0, obj_thresh);\n\xa0 \xa0 result.insert(result.begin(), boxes0.begin(), boxes0.end());\n\xa0 \xa0 auto boxes1 = decode_infer(output_1, net_len, 16, classes_num, frame_size, anchors_1, obj_thresh);\n\xa0 \xa0 result.insert(result.begin(), boxes1.begin(), boxes1.end());\n\xa0 \xa0 auto boxes2 = decode_infer(output_2, net_len, 32, classes_num, frame_size, anchors_2, obj_thresh);\n\xa0 \xa0 result.insert(result.begin(), boxes2.begin(), boxes2.end());\n\xa0 \xa0 nms(result, nms_thresh);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"decode_infer\u51fd\u6570\uff1a"}),"\n",(0,r.jsx)(e.p,{children:"\u8fdb\u884c\u540e\u5904\u7406\u64cd\u4f5c\uff0c\u5c06\u8f93\u51fa\u7684tensor\u7ed3\u679c\u8f6c\u6362\u4e3a\u5750\u6807\u7684\u683c\u5f0f\u5b58\u50a8\u5728vector\u5bb9\u5668\u4e2d\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160200499.png",alt:"image-20231012160200499"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"std::vector<BoxInfo> decode_infer(float *data, int net_size, int stride, int num_classes, Framesize frame_size, float anchors[][2], float threshold)\n{\n    // \u8ba1\u7b97\u6bd4\u4f8b\u548c\u589e\u76ca\uff0c\u7528\u4e8e\u7f29\u653e\u5750\u6807\n    float ratiow = (float)net_size / frame_size.width;\n    float ratioh = (float)net_size / frame_size.height;\n    float gain = ratiow < ratioh ? ratiow : ratioh;\n\n    // \u5b58\u50a8\u89e3\u7801\u540e\u7684\u8fb9\u754c\u6846\n    std::vector<BoxInfo> result;\n\n    // \u8ba1\u7b97\u7f51\u683c\u5927\u5c0f\n    int grid_size = net_size / stride;\n    int one_rsize = num_classes + 5;  // \u6bcf\u4e2a\u951a\u6846\u6709num_classes + 5\u4e2a\u503c\n\n    // \u904d\u5386\u7f51\u683c\n    for (int shift_y = 0; shift_y < grid_size; shift_y++)\n    {\n        for (int shift_x = 0; shift_x < grid_size; shift_x++)\n        {\n            int loc = shift_x + shift_y * grid_size;\n\n            // \u904d\u5386\u951a\u6846\n            for (int i = 0; i < 3; i++)\n            {\n                float *record = data + (loc * 3 + i) * one_rsize;\n                float *cls_ptr = record + 5;\n\n                // \u904d\u5386\u7c7b\u522b\n                for (int cls = 0; cls < num_classes; cls++)\n                {\n                    float score = (cls_ptr[cls]) * (record[4]);\n\n                    // \u68c0\u67e5\u5206\u6570\u662f\u5426\u8d85\u8fc7\u9608\u503c\n                    if (score > threshold)\n                    {\n                        // \u89e3\u7801\u8fb9\u754c\u6846\u5750\u6807\n                        cx = ((record[0]) * 2.f - 0.5f + (float)shift_x) * (float)stride;\n                        cy = ((record[1]) * 2.f - 0.5f + (float)shift_y) * (float)stride;\n                        w = pow((record[2]) * 2.f, 2) * anchors[i][0];\n                        h = pow((record[3]) * 2.f, 2) * anchors[i][1];\n                        cx -= ((net_size - frame_size.width * gain) / 2);\n                        cy -= ((net_size - frame_size.height * gain) / 2);\n                        cx /= gain;\n                        cy /= gain;\n                        w /= gain;\n                        h /= gain;\n\n                        // \u521b\u5efaBoxInfo\u7ed3\u6784\u5e76\u5c06\u5176\u6dfb\u52a0\u5230\u7ed3\u679c\u5411\u91cf\n                        BoxInfo box;\n                        box.x1 = std::max(0, std::min(frame_size.width, int(cx - w / 2.f)));\n                        box.y1 = std::max(0, std::min(frame_size.height, int(cy - h / 2.f)));\n                        box.x2 = std::max(0, std::min(frame_size.width, int(cx + w / 2.f)));\n                        box.y2 = std::max(0, std::min(frame_size.height, int(cy + h / 2.f)));\n                        box.score = score;\n                        box.label = cls;\n                        result.push_back(box);\n                    }\n                }\n            }\n        }\n    }\n\n    // \u8fd4\u56de\u89e3\u7801\u540e\u7684\u8fb9\u754c\u6846\u5411\u91cf\n    return result;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"nms\u51fd\u6570\uff1a"}),"\n",(0,r.jsx)(e.p,{children:"\u5220\u9664\u6a21\u578b\u9884\u6d4b\u540e\u5197\u4f59\u7684\u9884\u6d4b\u6846\uff0c\u4fdd\u7559\u6700\u4f73\u7684\u7ed3\u679c\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160207101.png",alt:"image-20231012160207101"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"12.\u7c7b\u522b\u540d\u6e05\u7406"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-C++",children:'/****fixed operation for display clear****/\n/****\u663e\u793a\u5c4f\u6e05\u7406\u7684\u56fa\u5b9a\u64cd\u4f5c****/\ncv::Mat img_argb;\nuint64_t index;\n{\n\xa0 \xa0 buf_mgt_writer_get(&buf_mgt, (void **)&index); //\u83b7\u53d6DRM\u7684\u5199\u5165\u6570\u636e\u7684\u80fd\u529b\n\xa0 \xa0 ScopedTiming st("display clear", enable_profile);\n\xa0 \xa0 struct drm_buffer *fbuf_argb = &drm_dev.drm_bufs_argb[index];\n\xa0 \xa0 img_argb = cv::Mat(screen_height, screen_width, CV_8UC4, (uint8_t *)fbuf_argb->map); //\u5c06\u56fe\u50cf\u8f93\u51fa\u81f3map\n\n    for (uint32_t cc = 0; cc < points_to_clear[index].size(); cc++)\n\xa0 \xa0 { \xa0 \xa0 \xa0 \xa0 \xa0\n\xa0 \xa0 \xa0 \xa0 cv::putText(img_argb, strs_to_clear[index][cc], points_to_clear[index][cc], cv::FONT_HERSHEY_COMPLEX, 1.5, cv::Scalar(0, 0, 0, 0), 1, 8, 0); //\u9884\u6d4b\u7684\u7c7b\u522b\u540d \u6e05\u7406\u4e3a\u9ed1\u8272\n\xa0 \xa0 }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u4e0b\u56fe\u6240\u793a\uff1a\u5c06\u663e\u793a\u5c4f\u4e0a\u7684\u7c7b\u522b\u540d\u79f0\u6e05\u7406\u4e3a\u9ed1\u8272"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160248794.png",alt:"image-20231012160248794"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"13.\u7ed8\u5236\u77e9\u5f62\u6846"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:"  for (auto r : result){\n    if (obj_cnt < 32){\n\tstruct vo_draw_frame frame; //\u521b\u5efa\u753b\u6846\u548c\u6807\u6ce8\u7684\u56fe\u50cf\n\tframe.crtc_id = drm_dev.crtc_id; \n\tframe.draw_en = 1; //\u662f\u5426\u7ed8\u5236\n\tframe.frame_num = obj_cnt; //\u7ed8\u5236\u4e2a\u6570\n\tint x1 = r.x2 * screen_width / valid_width;\n\tint x0 = r.x1 * screen_width / valid_width;\n\tint y0 = r.y1 * screen_height / valid_height;\n\tint y1 = r.y2 * screen_height / valid_height;\n\tx1 = std::max(0, std::min(x1, (int)screen_width)); //\u5982\u679cx1\u503c\u8d85\u51fa\u5c4f\u5e55\u5bbd\u5ea6\uff0c\u5219\u53d6\u5c4f\u5e55\u5bbd\u5ea6\n\tx0 = std::max(0, std::min(x0, (int)screen_width)); //\u5982\u679cx0\u503c\u8d85\u51fa\u5c4f\u5e55\u5bbd\u5ea6\uff0c\u5219\u53d6\u5c4f\u5e55\u5bbd\u5ea6\n\ty0 = std::max(0, std::min(y0, (int)screen_height)); //\u5982\u679cy0\u503c\u8d85\u51fa\u5c4f\u5e55\u5bbd\u5ea6\uff0c\u5219\u53d6\u5c4f\u5e55\u9ad8\u5ea6\n\ty1 = std::max(0, std::min(y1, (int)screen_height)); //\u5982\u679cy1\u503c\u8d85\u51fa\u5c4f\u5e55\u5bbd\u5ea6\uff0c\u5219\u53d6\u5c4f\u5e55\u9ad8\u5ea6\n\tframe.line_x_start = x0; //\u8bbe\u7f6ex\u8f74\u7684\u8d77\u70b9\n\tframe.line_x_end = x1; //\u8bbe\u7f6ex\u8f74\u7684\u7ec8\u70b9\n\tframe.line_y_start = y0; //\u8bbe\u7f6ey\u8f74\u7684\u8d77\u70b9\n\tframe.line_y_end = y1; //\u8bbe\u7f6ey\u8f74\u7684\u7ec8\u70b9\tdraw_frame(&frame); //\u7ed8\u5236\u77e9\u5f62\u6846\n\tcv::Point origin;\n\torigin.x = (int)(r.x1 * screen_width / valid_width); //\u7ed8\u5236\u5c55\u793a\u6807\u7b7e\u503c\u7684x\u5750\u6807\n\torigin.y = (int)(r.y1 * screen_height / valid_height + 10); //\u7ed8\u5236\u5c55\u793a\u6807\u7b7e\u503c\u7684y\u5750\u6807\n\t//\u4eceresult\u5bb9\u5668\u4e2d\u83b7\u53d6\u6807\u7b7e\u503c\n\tstd::string text = od.labels[r.label] + \u201c:\u201d + std::to_string(round(r.score * 100) / 100.0).substr(0,4);\n \t//\u5728\u6307\u5b9a\u7684\u5750\u6807\u5904\u7ed8\u5236\u6807\u7b7e\u503c\n\tcv::putText(img_argb, text, origin, cv::FONT_HERSHEY_COMPLEX, 1.5, cv::Scalar(0, 0, 255, 255), 1, 8, 0);\n\tpoints_to_clear[index].push_back(origin); //\u5c06\u5750\u6807\u503c\u52a0\u5165\u6e05\u7a7a\u5bb9\u5668\u4e2d\n\tstrs_to_clear[index].push_back(text); //\u5c06\u6807\u7b7e\u503c\u52a0\u5165\u6e05\u7a7a\u5bb9\u5668\u4e2d\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u7ed8\u5236\u9884\u6d4b\u6846\u548c\u9884\u6d4b\u7c7b\u522b\u548c\u9884\u6d4b\u6982\u7387\uff0c\u5e76\u5c06\u5176\u8f93\u51fa\u81f3\u663e\u793a\u5c4f\u4e0a\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160326697.png",alt:"image-20231012160326697"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"14.\u5c4f\u5e55\u6e05\u7406\u548c\u6444\u50cf\u5934\u91ca\u653e"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'\t/****\u663e\u793a\u5c4f\u6e05\u7406\u7684\u64cd\u4f5c****/\nfor (uint32_t i = obj_cnt; i < 32; i++) {\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 struct vo_draw_frame frame;\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 frame.crtc_id = drm_dev.crtc_id;\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 frame.draw_en = 0;\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 frame.frame_num = i;\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 draw_frame(&frame);\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 \xa0 \xa0 frame_cnt += 1;\n\xa0 \xa0 \xa0 \xa0 buf_mgt_writer_put(&buf_mgt, (void *)index);\n\xa0 \xa0 }\n\n\xa0 \xa0 /****fixed operation for capture release and display clear****/\n    /****\u56fa\u5b9a\u6444\u50cf\u5934\u6355\u83b7\u91ca\u653e\u548c\u663e\u793a\u6e05\u9664\u7684\u64cd\u4f5c****/\n\xa0 \xa0 printf("%s ==========release \\n", __func__);\n\xa0 \xa0 mtx.lock(); //\u83b7\u5f97\u9501\n\xa0 \xa0 capture.release(); // \u91ca\u653e\u6444\u50cf\u5934\u8d44\u6e90\n\xa0 \xa0 mtx.unlock(); //\u91ca\u653e\u9501\n\xa0 \xa0 for(uint32_t i = 0; i < 32; i++)\n\xa0 \xa0 {\n\xa0 \xa0 \xa0 \xa0 struct vo_draw_frame frame;\n\xa0 \xa0 \xa0 \xa0 frame.crtc_id = drm_dev.crtc_id;\n\xa0 \xa0 \xa0 \xa0 frame.draw_en = 0;\n\xa0 \xa0 \xa0 \xa0 frame.frame_num = i;\n\xa0 \xa0 \xa0 \xa0 draw_frame(&frame);\n\xa0 \xa0 }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160455292.png",alt:"image-20231012160455292"})}),"\n",(0,r.jsx)(e.p,{children:"AI\u5de5\u4f5c\u7684\u6d41\u7a0b\u56fe\u5982\u4e0b\u6240\u793a\uff1a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160526570.png",alt:"image-20231012160526570"})}),"\n",(0,r.jsx)(e.h3,{id:"125-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790--display_work",children:"12.5 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790- display_work"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528V4L2\u6253\u5f00\u6307\u5b9a\u6444\u50cf\u5934\u8bbe\u5907\u8282\u70b9\uff0c\u5e76\u5c06\u8c03\u7528DRM\u8f93\u51fa\u663e\u793a\u51fd\u6570\uff0c\u5c06\u89c6\u9891\u6d41buffer\u663e\u793a\u5728\u663e\u793a\u5c4f\u4e0a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'    mtx.lock(); //\u83b7\u5f97\u9501\n\xa0 \xa0 vdev = v4l2_open(dev_info[0].video_name[1]); //\u4f7f\u7528v4l2\u6253\u5f00\u6307\u5b9a\u6444\u50cf\u5934\u8bbe\u5907\u8282\u70b9\n\xa0 \xa0 if (vdev == NULL) {\n\xa0 \xa0 \xa0 \xa0 printf("error: unable to open video capture device %s\\n",\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 dev_info[0].video_name[1]);\n\xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 }\n\xa0 \xa0 memset(&format, 0, sizeof format);\n\xa0 \xa0 format.pixelformat = dev_info[0].video_out_format[1] ? V4L2_PIX_FMT_NV12 : V4L2_PIX_FMT_NV16; //\u8bbe\u7f6e\u89c6\u9891\u8f93\u51fa\u683c\u5f0f\n\xa0 \xa0 format.width = dev_info[0].video_width[1]; //\u8bbe\u7f6e\u89c6\u9891\u5bbd\u5ea6\n\xa0 \xa0 format.height = dev_info[0].video_height[1]; //\u8bbe\u7f6e\u89c6\u9891\u9ad8\u5ea6\n\xa0 \xa0 ret = v4l2_set_format(vdev, &format); //\u8bbe\u7f6e\u5e27\u683c\u5f0f\n\xa0 \xa0 if (ret < 0)\n\xa0 \xa0 {\n\xa0 \xa0 \xa0 \xa0 printf("%s:v4l2_set_format error\\n",__func__);\n\xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 }\n    ret = v4l2_alloc_buffers(vdev, V4L2_MEMORY_USERPTR, DRM_BUFFERS_COUNT); //\u7533\u8bf7\u5e27\u7f13\u51b2\n\xa0 \xa0 if (ret < 0)\n\xa0 \xa0 {\n\xa0 \xa0 \xa0 \xa0 printf("%s:v4l2_alloc_buffers error\\n",__func__);\n\xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 }\n    FD_ZERO(&fds); //\u5bf9\u5185\u5b58\u4e2d\u4fdd\u5b58\u7684\u6587\u4ef6\u53e5\u67c4\u8fdb\u884c\u6e05\u7406\u64cd\u4f5c\n\xa0 \xa0 FD_SET(vdev->fd, &fds); //\u7528\u6765\u5c06\u4e00\u4e2a\u7ed9\u5b9a\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u52a0\u5165\u96c6\u5408\u4e4b\u4e2d\n\xa0 \xa0 for (i = 0; i < vdev->nbufs; ++i) {\n\xa0 \xa0 \xa0 \xa0 buffer.index = i;\n\xa0 \xa0 \xa0 \xa0 fbuf_yuv = &drm_dev.drm_bufs[buffer.index];\n\xa0 \xa0 \xa0 \xa0 buffer.mem = fbuf_yuv->map;\n\xa0 \xa0 \xa0 \xa0 buffer.size = fbuf_yuv->size;\n\xa0 \xa0 \xa0 \xa0 ret = v4l2_queue_buffer(vdev, &buffer); //buffer\u5165\u961f\n\xa0 \xa0 \xa0 \xa0 if (ret < 0) {\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 printf("error: unable to queue buffer %u\\n", i);\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 \xa0 \xa0 } \xa0 \n\xa0 \xa0 }\n\xa0 \xa0 ret = v4l2_stream_on(vdev); //\u5f00\u542f\u89c6\u9891\u6d41\n\xa0 \xa0 if (ret < 0) {\n\xa0 \xa0 \xa0 \xa0 printf("%s error: failed to start video stream: %s (%d)\\n", __func__,\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 strerror(-ret), ret);\n\xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 }\n\xa0 \xa0 mtx.unlock();\n\xa0 \xa0 while(quit.load()) {\n\xa0 \xa0 \xa0 \xa0 struct timeval timeout;\n\xa0 \xa0 \xa0 \xa0 fd_set rfds;\n\xa0 \xa0 \xa0 \xa0 timeout.tv_sec = SELECT_TIMEOUT / 1000;\n\xa0 \xa0 \xa0 \xa0 timeout.tv_usec = (SELECT_TIMEOUT % 1000) * 1000;\n\xa0 \xa0 \xa0 \xa0 rfds = fds;\n\xa0 \xa0 \xa0 \xa0 ret = select(vdev->fd + 1, &rfds, NULL, NULL, &timeout); //\u5b9a\u65f6\u5668\u4f5c\u7528\uff0c\u5224\u65ad\u662f\u5426\u83b7\u53d6\u89c6\u9891\u8d85\u65f6\n\xa0 \xa0 \xa0 \xa0 if (ret < 0) {\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 if (errno == EINTR)\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 continue;\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 printf("error: select failed with %d\\n", errno);\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 \xa0 \xa0 if (ret == 0) {\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 printf("error: select timeout\\n");\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 goto display_cleanup;\n\xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 \xa0 \xa0 process_ds0_image(vdev, format.width, format.height); //\u4f7f\u7528DRM\u6846\u67b6\u5c06\u89c6\u9891\u8bbe\u5907\u6570\u636e\u663e\u793a\u5728\u663e\u793a\u5c4f\u4e0a\n\xa0 \xa0 }\ndisplay_cleanup:\n\xa0 \xa0 mtx.lock(); //\u83b7\u5f97\u9501\n\xa0 \xa0 video_stop(vdev); //\u5173\u95ed\u89c6\u9891\u6d41\n\xa0 \xa0 video_cleanup(vdev); //\u5173\u95ed\u5185\u5b58\u6620\u5c04\u76f8\u5173\u7684\u5185\u5b58\u5757\u548c\u5173\u95ed\u89c6\u9891\u8bbe\u5907\n\xa0 \xa0 mtx.unlock(); //\u91ca\u653e\u9501\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"126-yolov5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790--drm\u663e\u793a\u51fd\u6570process_ds0_image",children:"12.6 YOLOV5\u76ee\u6807\u68c0\u6d4b\u7a0b\u5e8f\u89e3\u6790- DRM\u663e\u793a\u51fd\u6570process_ds0_image"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c++",children:'static int process_ds0_image(struct v4l2_device *vdev, unsigned int width, unsigned int height)\n{\n\t// \u58f0\u660e\u4e00\u4e2a\u7ed3\u6784\u4f53\u7528\u4e8e\u5b58\u50a8\u89c6\u9891\u7f13\u51b2\u533a\u4fe1\u606f\n\tstruct v4l2_video_buffer buffer;\n\xa0 \xa0 int ret;\n    // \u58f0\u660e\u9759\u6001\u7ed3\u6784\u4f53\uff0c\u7528\u4e8e\u5b58\u50a8\u4e0a\u4e00\u5e27\u7684\u89c6\u9891\u7f13\u51b2\u533a\u4fe1\u606f\n\xa0 \xa0 static struct v4l2_video_buffer old_buffer;\n    // \u5c4f\u5e55\u521d\u59cb\u5316\u6807\u5fd7\uff0c\u7528\u4e8e\u6807\u8bc6\u5c4f\u5e55\u662f\u5426\u5df2\u521d\u59cb\u5316\n\xa0 \xa0 static int screen_init_flag = 0;\n\xa0 \xa0 mtx.lock(); //\u83b7\u5f97\u9501\n\xa0 \xa0 ret = v4l2_dequeue_buffer(vdev, &buffer); //\u628a\u6570\u636e\u653e\u56de\u7f13\u5b58\u961f\u5217\uff08\u51fa\u961f\uff09,\u5e76\u83b7\u53d6\u5230\u89c6\u9891buf\n\xa0 \xa0 if (ret < 0) {\n\xa0 \xa0 \xa0 \xa0 printf("error: unable to dequeue buffer: %s (%d)\\n",\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 strerror(-ret), ret);\n\xa0 \xa0 \xa0 \xa0 mtx.unlock(); //\u91ca\u653e\u9501\n\xa0 \xa0 \xa0 \xa0 return ret;\n\xa0 \xa0 }\n\xa0 \xa0 mtx.unlock(); //\u91ca\u653e\u9501\n    \n    // \u5982\u679c\u89c6\u9891\u7f13\u51b2\u533a\u5b58\u5728\u9519\u8bef\uff0c\u6253\u5370\u8b66\u544a\u4fe1\u606f\u5e76\u8df3\u8fc7\u5f53\u524d\u5e27\u7684\u5904\u7406\n\xa0 \xa0 if (buffer.error) {\n\xa0 \xa0 \xa0 \xa0 printf("warning: error in dequeued buffer, skipping\\n");\n\xa0 \xa0 \xa0 \xa0 return 0;\n\xa0 \xa0 }\n\xa0 \xa0 fbuf_yuv = &drm_dev.drm_bufs[buffer.index]; // \u83b7\u53d6\u5f53\u524d\u5e27\u7684\u89c6\u9891\u7f13\u51b2\u533a\u4fe1\u606f\n    \n    // \u5982\u679c\u5c4f\u5e55\u5df2\u7ecf\u521d\u59cb\u5316\n\xa0 \xa0 if (screen_init_flag) {\n\xa0 \xa0 \xa0 \xa0 if (drm_dev.req)\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 drm_wait_vsync(); //\u7b49\u5f85\u663e\u793a\u5c4f\u7a7a\u95f2\u65f6\u95f4\uff0c\u7b49\u5f85\u5b8c\u6210\u540e\u624d\u53ef\u4f20\u5165\u65b0\u6570\u636e\n\xa0 \xa0 \xa0 \xa0 uint64_t index;\n\xa0 \xa0 \xa0 \xa0 if (buf_mgt_display_get(&buf_mgt, (void **)&index) != 0) //\u83b7\u53d6DRM\u663e\u793a\u80fd\u529b\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 index = 0;\n        \n        //\u83b7\u53d6\u7528\u4e8e\u663e\u793a\u7684\u53e6\u4e00\u4e2a\u7f13\u51b2\u533a\u7684\u4fe1\u606f\n\xa0 \xa0 \xa0 \xa0 struct drm_buffer *fbuf_argb = &drm_dev.drm_bufs_argb[index];\n        \n        //\u8bbe\u7f6e\u5e73\u9762\u663e\u793a\n\xa0 \xa0 \xa0 \xa0 if (drm_dmabuf_set_plane(fbuf_yuv, fbuf_argb)) //\u5c06\u89c6\u9891buf\u4f20\u5165DRM\u663e\u793abuf\u4e2d\n\t{\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 std::cerr << "Flush fail \\n";\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 return 1;\n\xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 }\n    // \u5982\u679c\u5c4f\u5e55\u5df2\u7ecf\u521d\u59cb\u5316\n\xa0 \xa0 if(screen_init_flag) {\n\xa0 \xa0 \xa0 \xa0 fbuf_yuv = &drm_dev.drm_bufs[old_buffer.index]; // \u83b7\u53d6\u4e0a\u4e00\u5e27\u7684\u89c6\u9891\u7f13\u51b2\u533a\u4fe1\u606f\n\xa0 \xa0 \xa0 \xa0 old_buffer.mem = fbuf_yuv->map; // \u66f4\u65b0\u4e0a\u4e00\u5e27\u7684\u89c6\u9891\u7f13\u51b2\u533a\u4fe1\u606f\u5230 old_buffer \u7ed3\u6784\u4f53\n\xa0 \xa0 \xa0 \xa0 old_buffer.size = fbuf_yuv->size; //\u83b7\u53d6drm\u663e\u793abuf\u7684\u5927\u5c0f\n        //\u4f7f\u7528\u4e92\u65a5\u9501\u786e\u4fdd\u7ebf\u7a0b\u5b89\u5168\u6027\n\xa0 \xa0 \xa0 \xa0 mtx.lock();\n\xa0 \xa0 \xa0 \xa0 ret = v4l2_queue_buffer(vdev, &old_buffer); //\u628a\u6570\u636e\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u51fa\u6765\uff08\u5165\u961f\uff09\n\xa0 \xa0 \xa0 \xa0 if (ret < 0) {\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 printf("error: unable to requeue buffer: %s (%d)\\n",\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 strerror(-ret), ret);\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 return ret;\n\xa0 \xa0 \xa0 \xa0 }\n\xa0 \xa0 \xa0 \xa0 mtx.unlock();\n\xa0 \xa0 }\n\xa0 \xa0 else {\n\xa0 \xa0 \xa0 \xa0 screen_init_flag = 1;\n\xa0 \xa0 }\n\nold_buffer = buffer; //\u5c06buffer\u7684\u6570\u636e\u8d4b\u503c\u7ed9\u65e7buffer\n\nreturn 0;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"http://photos.100ask.net/eLinuxAI-TrainingDocs/image-20231012160852281.png",alt:"image-20231012160852281"})}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1aold_buffer\u662f\u9759\u6001\u53d8\u91cf\u4fdd\u5b58\u7740\u4e0a\u4e00\u4e2abuffer"}),"\n",(0,r.jsx)(e.p,{children:"DRM\u663e\u793a\u6d41\u7a0b\u4e3a\uff1a"}),"\n",(0,r.jsx)(e.p,{children:"1.Buffer\u83b7\u53d6\u65b0\u7684V4l2\u6570\u636e\uff0c\u4ea4\u7ed9DRM\u53bb\u505a\u663e\u793a\u64cd\u4f5c\u3002"}),"\n",(0,r.jsx)(e.p,{children:"2.\u7b49\u5f85\u4e0a\u4e00\u4e2abuffer\u4f20\u8f93\u5b8c\u6210\u540e\uff0c\u518d\u5c06\u65b0buffer\u4f20\u5165DRM\u53bb\u505a\u663e\u793a\u3002"}),"\n",(0,r.jsx)(e.p,{children:"3.old_buffer\u4fdd\u5b58\u7740\u4e0a\u4e00\u4e2abuffer\u7684\u6570\u636e\u548c\u5730\u5740\uff0c\u7531\u4e8e\u9700\u8981\u7b49\u5f85DRM\u8bfb\u53d6\u5e76\u663e\u793a\uff0c\u6240\u4ee5\u7b49\u5f85\u4e0b\u4e00\u56de\u5408\u624d\u53bb\u5165\u961f\u5f52\u8fd8buffer\u7ed9\u9a71\u52a8"})]})}function _(n={}){const{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(l,{...n})}):l(n)}},11151:(n,e,t)=>{t.d(e,{Z:()=>d,a:()=>a});var r=t(67294);const i={},s=r.createContext(i);function a(n){const e=r.useContext(s);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),r.createElement(s.Provider,{value:e},n.children)}}}]);